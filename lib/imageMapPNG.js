'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var namesUtilities = require('./utilities/names');

var asynchronousUtilities = necessary.asynchronousUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory,
    removeHiddenNames = namesUtilities.removeHiddenNames,
    dimensionFromNames = namesUtilities.dimensionFromNames;


function imageMapPNG(names, imageDirectoryPath, overlayImageSize, response) {
  if (!response) {
    response = overlayImageSize;
    overlayImageSize = imageDirectoryPath;
    imageDirectoryPath = names;
    names = readDirectory(imageDirectoryPath);
  }

  names = removeHiddenNames(names);

  var dimension = dimensionFromNames(names);

  createImageMap(dimension, overlayImageSize, function (imageBuffer) {
    var context = {
      names: names,
      dimension: dimension,
      imageBuffer: imageBuffer,
      overlayImageSize: overlayImageSize,
      imageDirectoryPath: imageDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var imageBuffer = context.imageBuffer;


      sharp(imageBuffer).pipe(response);
    }, context);
  });
}

module.exports = imageMapPNG;

function createImageMap(dimension, overlayImageSize, callback) {
  var width = dimension * overlayImageSize,
      height = dimension * overlayImageSize,
      channels = 4,
      background = { r: 0, g: 0, b: 0, alpha: 0 },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      imageMap = sharp({
    create: options ///
  });

  imageMap.png().toBuffer().then(function (imageBuffer) {
    callback(imageBuffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      dimension = context.dimension,
      imageBuffer = context.imageBuffer,
      overlayImageSize = context.overlayImageSize,
      imageDirectoryPath = context.imageDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = imageDirectoryPath + '/' + name;

  resizeImage(path, overlayImageSize, function (resizedImageBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayImageSize,
        left = index % dimension * overlayImageSize,
        options = {
      top: top,
      left: left
    };

    sharp(imageBuffer).overlayWith(resizedImageBuffer, options).toBuffer().then(function (imageBuffer) {
      Object.assign(context, {
        imageBuffer: imageBuffer
      });

      next();
    });
  });
}

function resizeImage(path, overlayImageSize, callback) {
  var width = overlayImageSize,
      ///
  height = overlayImageSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (imageBuffer) {
    var resizedImageBuffer = imageBuffer; ///

    callback(resizedImageBuffer);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9pbWFnZU1hcFBORy5qcyJdLCJuYW1lcyI6WyJzaGFycCIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJuYW1lc1V0aWxpdGllcyIsImFzeW5jaHJvbm91c1V0aWxpdGllcyIsImZpbGVTeXN0ZW1VdGlsaXRpZXMiLCJ3aGlsc3QiLCJyZWFkRGlyZWN0b3J5IiwicmVtb3ZlSGlkZGVuTmFtZXMiLCJkaW1lbnNpb25Gcm9tTmFtZXMiLCJpbWFnZU1hcFBORyIsIm5hbWVzIiwiaW1hZ2VEaXJlY3RvcnlQYXRoIiwib3ZlcmxheUltYWdlU2l6ZSIsInJlc3BvbnNlIiwiZGltZW5zaW9uIiwiY3JlYXRlSW1hZ2VNYXAiLCJpbWFnZUJ1ZmZlciIsImNvbnRleHQiLCJvdmVybGF5Q2FsbGJhY2siLCJ3cml0ZUhlYWQiLCJwaXBlIiwibW9kdWxlIiwiZXhwb3J0cyIsImNhbGxiYWNrIiwid2lkdGgiLCJoZWlnaHQiLCJjaGFubmVscyIsImJhY2tncm91bmQiLCJyIiwiZyIsImIiLCJhbHBoYSIsIm9wdGlvbnMiLCJpbWFnZU1hcCIsImNyZWF0ZSIsInBuZyIsInRvQnVmZmVyIiwidGhlbiIsIm5leHQiLCJkb25lIiwiaW5kZXgiLCJuYW1lc0xlbmd0aCIsImxlbmd0aCIsImxhc3RJbmRleCIsIm5hbWUiLCJwYXRoIiwicmVzaXplSW1hZ2UiLCJyZXNpemVkSW1hZ2VCdWZmZXIiLCJ0b3AiLCJNYXRoIiwiZmxvb3IiLCJsZWZ0Iiwib3ZlcmxheVdpdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJyZXNpemUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFFBQVFDLFFBQVEsT0FBUixDQUFkO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCOztBQUdBLElBQU1FLGlCQUFpQkYsUUFBUSxtQkFBUixDQUF2Qjs7SUFFUUcscUIsR0FBK0NGLFMsQ0FBL0NFLHFCO0lBQXVCQyxtQixHQUF3QkgsUyxDQUF4QkcsbUI7SUFDdkJDLE0sR0FBV0YscUIsQ0FBWEUsTTtJQUNBQyxhLEdBQWtCRixtQixDQUFsQkUsYTtJQUNBQyxpQixHQUEwQ0wsYyxDQUExQ0ssaUI7SUFBbUJDLGtCLEdBQXVCTixjLENBQXZCTSxrQjs7O0FBRTNCLFNBQVNDLFdBQVQsQ0FBcUJDLEtBQXJCLEVBQTRCQyxrQkFBNUIsRUFBZ0RDLGdCQUFoRCxFQUFrRUMsUUFBbEUsRUFBNEU7QUFDM0UsTUFBSSxDQUFDQSxRQUFMLEVBQWU7QUFDZEEsZUFBV0QsZ0JBQVg7QUFDQUEsdUJBQW1CRCxrQkFBbkI7QUFDQUEseUJBQXFCRCxLQUFyQjtBQUNBQSxZQUFRSixjQUFjSyxrQkFBZCxDQUFSO0FBQ0E7O0FBRURELFVBQVFILGtCQUFrQkcsS0FBbEIsQ0FBUjs7QUFFQSxNQUFNSSxZQUFZTixtQkFBbUJFLEtBQW5CLENBQWxCOztBQUVDSyxpQkFBZUQsU0FBZixFQUEwQkYsZ0JBQTFCLEVBQTRDLFVBQVNJLFdBQVQsRUFBc0I7QUFDaEUsUUFBTUMsVUFBVTtBQUNkUCxhQUFPQSxLQURPO0FBRWRJLGlCQUFXQSxTQUZHO0FBR2RFLG1CQUFhQSxXQUhDO0FBSWRKLHdCQUFrQkEsZ0JBSko7QUFLZEQsMEJBQW9CQTtBQUxOLEtBQWhCOztBQVFBTixXQUFPYSxlQUFQLEVBQXdCLFlBQVc7QUFDakNMLGVBQVNNLFNBQVQsQ0FBbUIsR0FBbkIsRUFBd0IsRUFBQyxnQkFBZ0IsMEJBQWpCLEVBQXhCOztBQURpQyxVQUd6QkgsV0FIeUIsR0FHVEMsT0FIUyxDQUd6QkQsV0FIeUI7OztBQUtqQ2pCLFlBQU1pQixXQUFOLEVBQW1CSSxJQUFuQixDQUF3QlAsUUFBeEI7QUFDRCxLQU5ELEVBTUdJLE9BTkg7QUFPRCxHQWhCRDtBQWlCRDs7QUFFREksT0FBT0MsT0FBUCxHQUFpQmIsV0FBakI7O0FBRUEsU0FBU00sY0FBVCxDQUF3QkQsU0FBeEIsRUFBbUNGLGdCQUFuQyxFQUFzRFcsUUFBdEQsRUFBZ0U7QUFDOUQsTUFBTUMsUUFBUVYsWUFBWUYsZ0JBQTFCO0FBQUEsTUFDTWEsU0FBU1gsWUFBWUYsZ0JBRDNCO0FBQUEsTUFFTWMsV0FBVyxDQUZqQjtBQUFBLE1BR01DLGFBQWEsRUFBRUMsR0FBRyxDQUFMLEVBQVFDLEdBQUcsQ0FBWCxFQUFjQyxHQUFHLENBQWpCLEVBQW9CQyxPQUFPLENBQTNCLEVBSG5CO0FBQUEsTUFJTUMsVUFBVTtBQUNSUixXQUFPQSxLQURDO0FBRVJDLFlBQVFBLE1BRkE7QUFHUkMsY0FBVUEsUUFIRjtBQUlSQyxnQkFBWUE7QUFKSixHQUpoQjtBQUFBLE1BVU1NLFdBQVdsQyxNQUFNO0FBQ2ZtQyxZQUFRRixPQURPLENBQ0M7QUFERCxHQUFOLENBVmpCOztBQWNBQyxXQUNHRSxHQURILEdBRUdDLFFBRkgsR0FHR0MsSUFISCxDQUdRLFVBQVNyQixXQUFULEVBQXNCO0FBQzFCTyxhQUFTUCxXQUFUO0FBQ0QsR0FMSDtBQU1EOztBQUVELFNBQVNFLGVBQVQsQ0FBeUJvQixJQUF6QixFQUErQkMsSUFBL0IsRUFBcUN0QixPQUFyQyxFQUE4Q3VCLEtBQTlDLEVBQXFEO0FBQUEsTUFDM0M5QixLQUQyQyxHQUM2Qk8sT0FEN0IsQ0FDM0NQLEtBRDJDO0FBQUEsTUFDcENJLFNBRG9DLEdBQzZCRyxPQUQ3QixDQUNwQ0gsU0FEb0M7QUFBQSxNQUN6QkUsV0FEeUIsR0FDNkJDLE9BRDdCLENBQ3pCRCxXQUR5QjtBQUFBLE1BQ1pKLGdCQURZLEdBQzZCSyxPQUQ3QixDQUNaTCxnQkFEWTtBQUFBLE1BQ01ELGtCQUROLEdBQzZCTSxPQUQ3QixDQUNNTixrQkFETjtBQUFBLE1BRTdDOEIsV0FGNkMsR0FFL0IvQixNQUFNZ0MsTUFGeUI7QUFBQSxNQUc3Q0MsU0FINkMsR0FHakNGLGNBQWMsQ0FIbUI7OztBQUtuRCxNQUFJRCxRQUFRRyxTQUFaLEVBQXVCO0FBQ3JCSjs7QUFFQTtBQUNEOztBQUVELE1BQU1LLE9BQU9sQyxNQUFNOEIsS0FBTixDQUFiO0FBQUEsTUFDTUssT0FBVWxDLGtCQUFWLFNBQWdDaUMsSUFEdEM7O0FBR0FFLGNBQVlELElBQVosRUFBa0JqQyxnQkFBbEIsRUFBb0MsVUFBU21DLGtCQUFULEVBQTZCO0FBQy9ELFFBQU1DLE1BQU0sQ0FBRWxDLFlBQVksQ0FBYixHQUFrQm1DLEtBQUtDLEtBQUwsQ0FBV1YsUUFBUTFCLFNBQW5CLENBQW5CLElBQXFERixnQkFBakU7QUFBQSxRQUNNdUMsT0FBUVgsUUFBUTFCLFNBQVQsR0FBc0JGLGdCQURuQztBQUFBLFFBRU1vQixVQUFVO0FBQ1JnQixXQUFLQSxHQURHO0FBRVJHLFlBQU1BO0FBRkUsS0FGaEI7O0FBT0FwRCxVQUFNaUIsV0FBTixFQUNHb0MsV0FESCxDQUNlTCxrQkFEZixFQUNtQ2YsT0FEbkMsRUFFR0ksUUFGSCxHQUdHQyxJQUhILENBR1EsVUFBU3JCLFdBQVQsRUFBc0I7QUFDMUJxQyxhQUFPQyxNQUFQLENBQWNyQyxPQUFkLEVBQXVCO0FBQ3JCRCxxQkFBYUE7QUFEUSxPQUF2Qjs7QUFJQXNCO0FBQ0QsS0FUSDtBQVVELEdBbEJEO0FBbUJEOztBQUVELFNBQVNRLFdBQVQsQ0FBcUJELElBQXJCLEVBQTJCakMsZ0JBQTNCLEVBQTZDVyxRQUE3QyxFQUF1RDtBQUNyRCxNQUFNQyxRQUFRWixnQkFBZDtBQUFBLE1BQWdDO0FBQzFCYSxXQUFTYixnQkFEZixDQURxRCxDQUVuQjs7QUFFbENiLFFBQU04QyxJQUFOLEVBQ0dVLE1BREgsQ0FDVS9CLEtBRFYsRUFDaUJDLE1BRGpCLEVBRUdXLFFBRkgsR0FHR0MsSUFISCxDQUdRLFVBQVNyQixXQUFULEVBQXNCO0FBQzFCLFFBQU0rQixxQkFBcUIvQixXQUEzQixDQUQwQixDQUNjOztBQUV4Q08sYUFBU3dCLGtCQUFUO0FBQ0QsR0FQSDtBQVFEIiwiZmlsZSI6ImltYWdlTWFwUE5HLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBzaGFycCA9IHJlcXVpcmUoJ3NoYXJwJyksXG4gICAgICBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKTtcblxuY29uc3QgbmFtZXNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9uYW1lcycpO1xuXG5jb25zdCB7IGFzeW5jaHJvbm91c1V0aWxpdGllcywgZmlsZVN5c3RlbVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyB3aGlsc3QgfSA9IGFzeW5jaHJvbm91c1V0aWxpdGllcyxcbiAgICAgIHsgcmVhZERpcmVjdG9yeSB9ID0gZmlsZVN5c3RlbVV0aWxpdGllcyxcbiAgICAgIHsgcmVtb3ZlSGlkZGVuTmFtZXMsIGRpbWVuc2lvbkZyb21OYW1lcyB9ID0gbmFtZXNVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGltYWdlTWFwUE5HKG5hbWVzLCBpbWFnZURpcmVjdG9yeVBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIHJlc3BvbnNlKSB7XG5cdGlmICghcmVzcG9uc2UpIHtcblx0XHRyZXNwb25zZSA9IG92ZXJsYXlJbWFnZVNpemU7XG5cdFx0b3ZlcmxheUltYWdlU2l6ZSA9IGltYWdlRGlyZWN0b3J5UGF0aDtcblx0XHRpbWFnZURpcmVjdG9yeVBhdGggPSBuYW1lcztcblx0XHRuYW1lcyA9IHJlYWREaXJlY3RvcnkoaW1hZ2VEaXJlY3RvcnlQYXRoKTtcblx0fVxuXG5cdG5hbWVzID0gcmVtb3ZlSGlkZGVuTmFtZXMobmFtZXMpO1xuXG5cdGNvbnN0IGRpbWVuc2lvbiA9IGRpbWVuc2lvbkZyb21OYW1lcyhuYW1lcyk7XG5cbiAgY3JlYXRlSW1hZ2VNYXAoZGltZW5zaW9uLCBvdmVybGF5SW1hZ2VTaXplLCBmdW5jdGlvbihpbWFnZUJ1ZmZlcikge1xuICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICBuYW1lczogbmFtZXMsXG4gICAgICBkaW1lbnNpb246IGRpbWVuc2lvbixcbiAgICAgIGltYWdlQnVmZmVyOiBpbWFnZUJ1ZmZlcixcbiAgICAgIG92ZXJsYXlJbWFnZVNpemU6IG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICBpbWFnZURpcmVjdG9yeVBhdGg6IGltYWdlRGlyZWN0b3J5UGF0aFxuICAgIH07XG4gICAgXG4gICAgd2hpbHN0KG92ZXJsYXlDYWxsYmFjaywgZnVuY3Rpb24oKSB7XG4gICAgICByZXNwb25zZS53cml0ZUhlYWQoMjAwLCB7J0NvbnRlbnQtVHlwZSc6ICdpbWFnZS9wbmc7IGNoYXJzZXQ9dXRmLTgnfSk7XG5cbiAgICAgIGNvbnN0IHsgaW1hZ2VCdWZmZXIgfSA9IGNvbnRleHQ7XG5cbiAgICAgIHNoYXJwKGltYWdlQnVmZmVyKS5waXBlKHJlc3BvbnNlKTtcbiAgICB9LCBjb250ZXh0KTtcbiAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gaW1hZ2VNYXBQTkc7XG5cbmZ1bmN0aW9uIGNyZWF0ZUltYWdlTWFwKGRpbWVuc2lvbiwgb3ZlcmxheUltYWdlU2l6ZSwgIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHdpZHRoID0gZGltZW5zaW9uICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgaGVpZ2h0ID0gZGltZW5zaW9uICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgY2hhbm5lbHMgPSA0LFxuICAgICAgICBiYWNrZ3JvdW5kID0geyByOiAwLCBnOiAwLCBiOiAwLCBhbHBoYTogMCB9LFxuICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgIHdpZHRoOiB3aWR0aCxcbiAgICAgICAgICBoZWlnaHQ6IGhlaWdodCxcbiAgICAgICAgICBjaGFubmVsczogY2hhbm5lbHMsXG4gICAgICAgICAgYmFja2dyb3VuZDogYmFja2dyb3VuZFxuICAgICAgICB9LFxuICAgICAgICBpbWFnZU1hcCA9IHNoYXJwKHtcbiAgICAgICAgICBjcmVhdGU6IG9wdGlvbnMgLy8vXG4gICAgICAgIH0pO1xuXG4gIGltYWdlTWFwXG4gICAgLnBuZygpXG4gICAgLnRvQnVmZmVyKClcbiAgICAudGhlbihmdW5jdGlvbihpbWFnZUJ1ZmZlcikge1xuICAgICAgY2FsbGJhY2soaW1hZ2VCdWZmZXIpXG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIG92ZXJsYXlDYWxsYmFjayhuZXh0LCBkb25lLCBjb250ZXh0LCBpbmRleCkge1xuICBjb25zdCB7IG5hbWVzLCBkaW1lbnNpb24sIGltYWdlQnVmZmVyLCBvdmVybGF5SW1hZ2VTaXplLCBpbWFnZURpcmVjdG9yeVBhdGggfSA9IGNvbnRleHQsXG4gICAgICAgIG5hbWVzTGVuZ3RoID0gbmFtZXMubGVuZ3RoLFxuICAgICAgICBsYXN0SW5kZXggPSBuYW1lc0xlbmd0aCAtIDE7XG5cbiAgaWYgKGluZGV4ID4gbGFzdEluZGV4KSB7XG4gICAgZG9uZSgpO1xuICAgIFxuICAgIHJldHVybjtcbiAgfVxuICBcbiAgY29uc3QgbmFtZSA9IG5hbWVzW2luZGV4XSxcbiAgICAgICAgcGF0aCA9IGAke2ltYWdlRGlyZWN0b3J5UGF0aH0vJHtuYW1lfWA7XG5cbiAgcmVzaXplSW1hZ2UocGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgZnVuY3Rpb24ocmVzaXplZEltYWdlQnVmZmVyKSB7XG4gICAgY29uc3QgdG9wID0gKChkaW1lbnNpb24gLSAxKSAtIE1hdGguZmxvb3IoaW5kZXggLyBkaW1lbnNpb24pICkgKiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgICAgIGxlZnQgPSAoaW5kZXggJSBkaW1lbnNpb24pICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgICAgdG9wOiB0b3AsXG4gICAgICAgICAgICBsZWZ0OiBsZWZ0XG4gICAgICAgICAgfTtcblxuICAgIHNoYXJwKGltYWdlQnVmZmVyKVxuICAgICAgLm92ZXJsYXlXaXRoKHJlc2l6ZWRJbWFnZUJ1ZmZlciwgb3B0aW9ucylcbiAgICAgIC50b0J1ZmZlcigpXG4gICAgICAudGhlbihmdW5jdGlvbihpbWFnZUJ1ZmZlcikge1xuICAgICAgICBPYmplY3QuYXNzaWduKGNvbnRleHQsIHtcbiAgICAgICAgICBpbWFnZUJ1ZmZlcjogaW1hZ2VCdWZmZXJcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbmV4dCgpO1xuICAgICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXNpemVJbWFnZShwYXRoLCBvdmVybGF5SW1hZ2VTaXplLCBjYWxsYmFjaykge1xuICBjb25zdCB3aWR0aCA9IG92ZXJsYXlJbWFnZVNpemUsIC8vL1xuICAgICAgICBoZWlnaHQgPSBvdmVybGF5SW1hZ2VTaXplOyAgLy8vXG4gIFxuICBzaGFycChwYXRoKVxuICAgIC5yZXNpemUod2lkdGgsIGhlaWdodClcbiAgICAudG9CdWZmZXIoKVxuICAgIC50aGVuKGZ1bmN0aW9uKGltYWdlQnVmZmVyKSB7XG4gICAgICBjb25zdCByZXNpemVkSW1hZ2VCdWZmZXIgPSBpbWFnZUJ1ZmZlcjsgLy8vXG4gICAgICBcbiAgICAgIGNhbGxiYWNrKHJlc2l6ZWRJbWFnZUJ1ZmZlcik7XG4gICAgfSk7XG59XG4iXX0=