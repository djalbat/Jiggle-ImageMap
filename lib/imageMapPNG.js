'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var namesUtilities = require('./utilities/names');

var asynchronousUtilities = necessary.asynchronousUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory,
    dimensionFromNames = namesUtilities.dimensionFromNames;


function imageMapPNG(imageDirectoryPath, overlayImageSize, response) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names);

  createImageMap(dimension, overlayImageSize, function (imageBuffer) {
    var context = {
      names: names,
      dimension: dimension,
      imageBuffer: imageBuffer,
      overlayImageSize: overlayImageSize,
      imageDirectoryPath: imageDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var imageBuffer = context.imageBuffer;


      sharp(imageBuffer).pipe(response);
    }, context);
  });
}

module.exports = imageMapPNG;

function createImageMap(dimension, overlayImageSize, callback) {
  var width = dimension * overlayImageSize,
      height = dimension * overlayImageSize,
      channels = 4,
      background = { r: 0, g: 0, b: 0, alpha: 0 },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      imageMap = sharp({
    create: options ///
  });

  imageMap.png().toBuffer().then(function (imageBuffer) {
    callback(imageBuffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      dimension = context.dimension,
      imageBuffer = context.imageBuffer,
      overlayImageSize = context.overlayImageSize,
      imageDirectoryPath = context.imageDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = imageDirectoryPath + '/' + name;

  resizeImage(path, overlayImageSize, function (resizedImageBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayImageSize,
        left = index % dimension * overlayImageSize,
        options = {
      top: top,
      left: left
    };

    sharp(imageBuffer).overlayWith(resizedImageBuffer, options).toBuffer().then(function (imageBuffer) {
      Object.assign(context, {
        imageBuffer: imageBuffer
      });

      next();
    });
  });
}

function resizeImage(path, overlayImageSize, callback) {
  var width = overlayImageSize,
      ///
  height = overlayImageSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (imageBuffer) {
    var resizedImageBuffer = imageBuffer; ///

    callback(resizedImageBuffer);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9pbWFnZU1hcFBORy5qcyJdLCJuYW1lcyI6WyJzaGFycCIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJuYW1lc1V0aWxpdGllcyIsImFzeW5jaHJvbm91c1V0aWxpdGllcyIsImZpbGVTeXN0ZW1VdGlsaXRpZXMiLCJ3aGlsc3QiLCJyZWFkRGlyZWN0b3J5IiwiZGltZW5zaW9uRnJvbU5hbWVzIiwiaW1hZ2VNYXBQTkciLCJpbWFnZURpcmVjdG9yeVBhdGgiLCJvdmVybGF5SW1hZ2VTaXplIiwicmVzcG9uc2UiLCJuYW1lcyIsImRpbWVuc2lvbiIsImNyZWF0ZUltYWdlTWFwIiwiaW1hZ2VCdWZmZXIiLCJjb250ZXh0Iiwib3ZlcmxheUNhbGxiYWNrIiwid3JpdGVIZWFkIiwicGlwZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJjYWxsYmFjayIsIndpZHRoIiwiaGVpZ2h0IiwiY2hhbm5lbHMiLCJiYWNrZ3JvdW5kIiwiciIsImciLCJiIiwiYWxwaGEiLCJvcHRpb25zIiwiaW1hZ2VNYXAiLCJjcmVhdGUiLCJwbmciLCJ0b0J1ZmZlciIsInRoZW4iLCJuZXh0IiwiZG9uZSIsImluZGV4IiwibmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJsYXN0SW5kZXgiLCJuYW1lIiwicGF0aCIsInJlc2l6ZUltYWdlIiwicmVzaXplZEltYWdlQnVmZmVyIiwidG9wIiwiTWF0aCIsImZsb29yIiwibGVmdCIsIm92ZXJsYXlXaXRoIiwiT2JqZWN0IiwiYXNzaWduIiwicmVzaXplIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxRQUFRQyxRQUFRLE9BQVIsQ0FBZDtBQUFBLElBQ01DLFlBQVlELFFBQVEsV0FBUixDQURsQjs7QUFHQSxJQUFNRSxpQkFBaUJGLFFBQVEsbUJBQVIsQ0FBdkI7O0lBRVFHLHFCLEdBQStDRixTLENBQS9DRSxxQjtJQUF1QkMsbUIsR0FBd0JILFMsQ0FBeEJHLG1CO0lBQ3ZCQyxNLEdBQVdGLHFCLENBQVhFLE07SUFDQUMsYSxHQUFrQkYs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LEdBREc7QUFFUkcsWUFBTUE7QUFGRSxLQUZoQjs7QUFPQW5ELFVBQU1nQixXQUFOLEVBQ0dvQyxXQURILENBQ2VMLGtCQURmLEVBQ21DZixPQURuQyxFQUVHSSxRQUZILEdBR0dDLElBSEgsQ0FHUSxVQUFTckIsV0FBVCxFQUFzQjtBQUMxQnFDLGFBQU9DLE1BQVAsQ0FBY3JDLE9BQWQsRUFBdUI7QUFDckJELHFCQUFhQTtBQURRLE9BQXZCOztBQUlBc0I7QUFDRCxLQVRIO0FBVUQsR0FsQkQ7QUFtQkQ7O0FBRUQsU0FBU1EsV0FBVCxDQUFxQkQsSUFBckIsRUFBMkJsQyxnQkFBM0IsRUFBNkNZLFFBQTdDLEVBQXVEO0FBQ3JELE1BQU1DLFFBQVFiLGdCQUFkO0FBQUEsTUFBZ0M7QUFDMUJjLFdBQVNkLGdCQURmLENBRHFELENBRW5COztBQUVsQ1gsUUFBTTZDLElBQU4sRUFDR1UsTUFESCxDQUNVL0IsS0FEVixFQUNpQkMsTUFEakIsRUFFR1csUUFGSCxHQUdHQyxJQUhILENBR1EsVUFBU3JCLFdBQVQsRUFBc0I7QUFDMUIsUUFBTStCLHFCQUFxQi9CLFdBQTNCLENBRDBCLENBQ2M7O0FBRXhDTyxhQUFTd0Isa0JBQVQ7QUFDRCxHQVBIO0FBUUQiLCJmaWxlIjoiaW1hZ2VNYXBQTkcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHNoYXJwID0gcmVxdWlyZSgnc2hhcnAnKSxcbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBuYW1lc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL25hbWVzJyk7XG5cbmNvbnN0IHsgYXN5bmNocm9ub3VzVXRpbGl0aWVzLCBmaWxlU3lzdGVtVXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IHdoaWxzdCB9ID0gYXN5bmNocm9ub3VzVXRpbGl0aWVzLFxuICAgICAgeyByZWFkRGlyZWN0b3J5IH0gPSBmaWxlU3lzdGVtVXRpbGl0aWVzLFxuICAgICAgeyBkaW1lbnNpb25Gcm9tTmFtZXMgfSA9IG5hbWVzVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBpbWFnZU1hcFBORyhpbWFnZURpcmVjdG9yeVBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIHJlc3BvbnNlKSB7XG4gIGNvbnN0IG5hbWVzID0gcmVhZERpcmVjdG9yeShpbWFnZURpcmVjdG9yeVBhdGgpLFxuICAgICAgICBkaW1lbnNpb24gPSBkaW1lbnNpb25Gcm9tTmFtZXMobmFtZXMpO1xuXG4gIGNyZWF0ZUltYWdlTWFwKGRpbWVuc2lvbiwgb3ZlcmxheUltYWdlU2l6ZSwgZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgbmFtZXM6IG5hbWVzLFxuICAgICAgZGltZW5zaW9uOiBkaW1lbnNpb24sXG4gICAgICBpbWFnZUJ1ZmZlcjogaW1hZ2VCdWZmZXIsXG4gICAgICBvdmVybGF5SW1hZ2VTaXplOiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgaW1hZ2VEaXJlY3RvcnlQYXRoOiBpbWFnZURpcmVjdG9yeVBhdGhcbiAgICB9O1xuICAgIFxuICAgIHdoaWxzdChvdmVybGF5Q2FsbGJhY2ssIGZ1bmN0aW9uKCkge1xuICAgICAgcmVzcG9uc2Uud3JpdGVIZWFkKDIwMCwgeydDb250ZW50LVR5cGUnOiAnaW1hZ2UvcG5nOyBjaGFyc2V0PXV0Zi04J30pO1xuXG4gICAgICBjb25zdCB7IGltYWdlQnVmZmVyIH0gPSBjb250ZXh0O1xuXG4gICAgICBzaGFycChpbWFnZUJ1ZmZlcikucGlwZShyZXNwb25zZSk7XG4gICAgfSwgY29udGV4dCk7XG4gIH0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGltYWdlTWFwUE5HO1xuXG5mdW5jdGlvbiBjcmVhdGVJbWFnZU1hcChkaW1lbnNpb24sIG92ZXJsYXlJbWFnZVNpemUsICBjYWxsYmFjaykge1xuICBjb25zdCB3aWR0aCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGhlaWdodCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGNoYW5uZWxzID0gNCxcbiAgICAgICAgYmFja2dyb3VuZCA9IHsgcjogMCwgZzogMCwgYjogMCwgYWxwaGE6IDAgfSxcbiAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICB3aWR0aDogd2lkdGgsXG4gICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgY2hhbm5lbHM6IGNoYW5uZWxzLFxuICAgICAgICAgIGJhY2tncm91bmQ6IGJhY2tncm91bmRcbiAgICAgICAgfSxcbiAgICAgICAgaW1hZ2VNYXAgPSBzaGFycCh7XG4gICAgICAgICAgY3JlYXRlOiBvcHRpb25zIC8vL1xuICAgICAgICB9KTtcblxuICBpbWFnZU1hcFxuICAgIC5wbmcoKVxuICAgIC50b0J1ZmZlcigpXG4gICAgLnRoZW4oZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICAgIGNhbGxiYWNrKGltYWdlQnVmZmVyKVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBvdmVybGF5Q2FsbGJhY2sobmV4dCwgZG9uZSwgY29udGV4dCwgaW5kZXgpIHtcbiAgY29uc3QgeyBuYW1lcywgZGltZW5zaW9uLCBpbWFnZUJ1ZmZlciwgb3ZlcmxheUltYWdlU2l6ZSwgaW1hZ2VEaXJlY3RvcnlQYXRoIH0gPSBjb250ZXh0LFxuICAgICAgICBuYW1lc0xlbmd0aCA9IG5hbWVzLmxlbmd0aCxcbiAgICAgICAgbGFzdEluZGV4ID0gbmFtZXNMZW5ndGggLSAxO1xuXG4gIGlmIChpbmRleCA+IGxhc3RJbmRleCkge1xuICAgIGRvbmUoKTtcbiAgICBcbiAgICByZXR1cm47XG4gIH1cbiAgXG4gIGNvbnN0IG5hbWUgPSBuYW1lc1tpbmRleF0sXG4gICAgICAgIHBhdGggPSBgJHtpbWFnZURpcmVjdG9yeVBhdGh9LyR7bmFtZX1gO1xuXG4gIHJlc2l6ZUltYWdlKHBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIGZ1bmN0aW9uKHJlc2l6ZWRJbWFnZUJ1ZmZlcikge1xuICAgIGNvbnN0IHRvcCA9ICgoZGltZW5zaW9uIC0gMSkgLSBNYXRoLmZsb29yKGluZGV4IC8gZGltZW5zaW9uKSApICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgICBsZWZ0ID0gKGluZGV4ICUgZGltZW5zaW9uKSAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHRvcDogdG9wLFxuICAgICAgICAgICAgbGVmdDogbGVmdFxuICAgICAgICAgIH07XG5cbiAgICBzaGFycChpbWFnZUJ1ZmZlcilcbiAgICAgIC5vdmVybGF5V2l0aChyZXNpemVkSW1hZ2VCdWZmZXIsIG9wdGlvbnMpXG4gICAgICAudG9CdWZmZXIoKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgICAgaW1hZ2VCdWZmZXI6IGltYWdlQnVmZmVyXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVzaXplSW1hZ2UocGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgY2FsbGJhY2spIHtcbiAgY29uc3Qgd2lkdGggPSBvdmVybGF5SW1hZ2VTaXplLCAvLy9cbiAgICAgICAgaGVpZ2h0ID0gb3ZlcmxheUltYWdlU2l6ZTsgIC8vL1xuICBcbiAgc2hhcnAocGF0aClcbiAgICAucmVzaXplKHdpZHRoLCBoZWlnaHQpXG4gICAgLnRvQnVmZmVyKClcbiAgICAudGhlbihmdW5jdGlvbihpbWFnZUJ1ZmZlcikge1xuICAgICAgY29uc3QgcmVzaXplZEltYWdlQnVmZmVyID0gaW1hZ2VCdWZmZXI7IC8vL1xuICAgICAgXG4gICAgICBjYWxsYmFjayhyZXNpemVkSW1hZ2VCdWZmZXIpO1xuICAgIH0pO1xufVxuIl19