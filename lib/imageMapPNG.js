'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var namesUtilities = require('./utilities/names');

var asynchronousUtilities = necessary.asynchronousUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory,
    removeHiddenNames = namesUtilities.removeHiddenNames,
    dimensionFromNames = namesUtilities.dimensionFromNames;


function imageMapPNG(imageDirectoryPath, overlayImageSize, response) {
  var names = readDirectory(imageDirectoryPath);

  names = removeHiddenNames(names);

  var dimension = dimensionFromNames(names);

  createImageMap(dimension, overlayImageSize, function (imageBuffer) {
    var context = {
      names: names,
      dimension: dimension,
      imageBuffer: imageBuffer,
      overlayImageSize: overlayImageSize,
      imageDirectoryPath: imageDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var imageBuffer = context.imageBuffer;


      sharp(imageBuffer).pipe(response);
    }, context);
  });
}

module.exports = imageMapPNG;

function createImageMap(dimension, overlayImageSize, callback) {
  var width = dimension * overlayImageSize,
      height = dimension * overlayImageSize,
      channels = 4,
      background = { r: 0, g: 0, b: 0, alpha: 0 },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      imageMap = sharp({
    create: options ///
  });

  imageMap.png().toBuffer().then(function (imageBuffer) {
    callback(imageBuffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      dimension = context.dimension,
      imageBuffer = context.imageBuffer,
      overlayImageSize = context.overlayImageSize,
      imageDirectoryPath = context.imageDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = imageDirectoryPath + '/' + name;

  resizeImage(path, overlayImageSize, function (resizedImageBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayImageSize,
        left = index % dimension * overlayImageSize,
        options = {
      top: top,
      left: left
    };

    sharp(imageBuffer).overlayWith(resizedImageBuffer, options).toBuffer().then(function (imageBuffer) {
      Object.assign(context, {
        imageBuffer: imageBuffer
      });

      next();
    });
  });
}

function resizeImage(path, overlayImageSize, callback) {
  var width = overlayImageSize,
      ///
  height = overlayImageSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (imageBuffer) {
    var resizedImageBuffer = imageBuffer; ///

    callback(resizedImageBuffer);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9pbWFnZU1hcFBORy5qcyJdLCJuYW1lcyI6WyJzaGFycCIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJuYW1lc1V0aWxpdGllcyIsImFzeW5jaHJvbm91c1V0aWxpdGllcyIsImZpbGVTeXN0ZW1VdGlsaXRpZXMiLCJ3aGlsc3QiLCJyZWFkRGlyZWN0b3J5IiwicmVtb3ZlSGlkZGVuTmFtZXMiLCJkaW1lbnNpb25Gcm9tTmFtZXMiLCJpbWFnZU1hcFBORyIsImltYWdlRGlyZWN0b3J5UGF0aCIsIm92ZXJsYXlJbWFnZVNpemUiLCJyZXNwb25zZSIsIm5hbWVzIiwiZGltZW5zaW9uIiwiY3JlYXRlSW1hZ2VNYXAiLCJpbWFnZUJ1ZmZlciIsImNvbnRleHQiLCJvdmVybGF5Q2FsbGJhY2siLCJ3cml0ZUhlYWQiLCJwaXBlIiwibW9kdWxlIiwiZXhwb3J0cyIsImNhbGxiYWNrIiwid2lkdGgiLCJoZWlnaHQiLCJjaGFubmVscyIsImJhY2tncm91bmQiLCJyIiwiZyIsImIiLCJhbHBoYSIsIm9wdGlvbnMiLCJpbWFnZU1hcCIsImNyZWF0ZSIsInBuZyIsInRvQnVmZmVyIiwidGhlbiIsIm5leHQiLCJkb25lIiwiaW5kZXgiLCJuYW1lc0xlbmd0aCIsImxlbmd0aCIsImxhc3RJbmRleCIsIm5hbWUiLCJwYXRoIiwicmVzaXplSW1hZ2UiLCJyZXNpemVkSW1hZ2VCdWZmZXIiLCJ0b3AiLCJNYXRoIiwiZmxvb3IiLCJsZWZ0Iiwib3ZlcmxheVdpdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJyZXNpemUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFFBQVFDLFFBQVEsT0FBUixDQUFkO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCOztBQUdBLElBQU1FLGlCQUFpQkYsUUFBUSxtQkFBUixDQUF2Qjs7SUFFUUcscUIsR0FBK0NGLFMsQ0FBL0NFLHFCO0lBQXVCQyxtQixHQUF3QkgsUyxDQUF4QkcsbUI7SUFDdkJDLE0sR0FBV0YscUIsQ0FB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REgsZ0JBQWpFO0FBQUEsUUFDTXdDLE9BQVFYLFFBQVExQixTQUFULEdBQXNCSCxnQkFEbkM7QUFBQSxRQUVNcUIsVUFBVTtBQUNSZ0IsV0FBS0EsR0FERztBQUVSRyxZQUFNQTtBQUZFLEtBRmhCOztBQU9BcEQsVUFBTWlCLFdBQU4sRUFDR29DLFdBREgsQ0FDZUwsa0JBRGYsRUFDbUNmLE9BRG5DLEVBRUdJLFFBRkgsR0FHR0MsSUFISCxDQUdRLFVBQVNyQixXQUFULEVBQXNCO0FBQzFCcUMsYUFBT0MsTUFBUCxDQUFjckMsT0FBZCxFQUF1QjtBQUNyQkQscUJBQWFBO0FBRFEsT0FBdkI7O0FBSUFzQjtBQUNELEtBVEg7QUFVRCxHQWxCRDtBQW1CRDs7QUFFRCxTQUFTUSxXQUFULENBQXFCRCxJQUFyQixFQUEyQmxDLGdCQUEzQixFQUE2Q1ksUUFBN0MsRUFBdUQ7QUFDckQsTUFBTUMsUUFBUWIsZ0JBQWQ7QUFBQSxNQUFnQztBQUMxQmMsV0FBU2QsZ0JBRGYsQ0FEcUQsQ0FFbkI7O0FBRWxDWixRQUFNOEMsSUFBTixFQUNHVSxNQURILENBQ1UvQixLQURWLEVBQ2lCQyxNQURqQixFQUVHVyxRQUZILEdBR0dDLElBSEgsQ0FHUSxVQUFTckIsV0FBVCxFQUFzQjtBQUMxQixRQUFNK0IscUJBQXFCL0IsV0FBM0IsQ0FEMEIsQ0FDYzs7QUFFeENPLGFBQVN3QixrQkFBVDtBQUNELEdBUEg7QUFRRCIsImZpbGUiOiJpbWFnZU1hcFBORy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3Qgc2hhcnAgPSByZXF1aXJlKCdzaGFycCcpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IG5hbWVzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvbmFtZXMnKTtcblxuY29uc3QgeyBhc3luY2hyb25vdXNVdGlsaXRpZXMsIGZpbGVTeXN0ZW1VdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgd2hpbHN0IH0gPSBhc3luY2hyb25vdXNVdGlsaXRpZXMsXG4gICAgICB7IHJlYWREaXJlY3RvcnkgfSA9IGZpbGVTeXN0ZW1VdGlsaXRpZXMsXG4gICAgICB7IHJlbW92ZUhpZGRlbk5hbWVzLCBkaW1lbnNpb25Gcm9tTmFtZXMgfSA9IG5hbWVzVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBpbWFnZU1hcFBORyhpbWFnZURpcmVjdG9yeVBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIHJlc3BvbnNlKSB7XG4gIGxldCBuYW1lcyA9IHJlYWREaXJlY3RvcnkoaW1hZ2VEaXJlY3RvcnlQYXRoKTtcblxuXHRuYW1lcyA9IHJlbW92ZUhpZGRlbk5hbWVzKG5hbWVzKTtcblxuXHRjb25zdCBkaW1lbnNpb24gPSBkaW1lbnNpb25Gcm9tTmFtZXMobmFtZXMpO1xuXG4gIGNyZWF0ZUltYWdlTWFwKGRpbWVuc2lvbiwgb3ZlcmxheUltYWdlU2l6ZSwgZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgbmFtZXM6IG5hbWVzLFxuICAgICAgZGltZW5zaW9uOiBkaW1lbnNpb24sXG4gICAgICBpbWFnZUJ1ZmZlcjogaW1hZ2VCdWZmZXIsXG4gICAgICBvdmVybGF5SW1hZ2VTaXplOiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgaW1hZ2VEaXJlY3RvcnlQYXRoOiBpbWFnZURpcmVjdG9yeVBhdGhcbiAgICB9O1xuICAgIFxuICAgIHdoaWxzdChvdmVybGF5Q2FsbGJhY2ssIGZ1bmN0aW9uKCkge1xuICAgICAgcmVzcG9uc2Uud3JpdGVIZWFkKDIwMCwgeydDb250ZW50LVR5cGUnOiAnaW1hZ2UvcG5nOyBjaGFyc2V0PXV0Zi04J30pO1xuXG4gICAgICBjb25zdCB7IGltYWdlQnVmZmVyIH0gPSBjb250ZXh0O1xuXG4gICAgICBzaGFycChpbWFnZUJ1ZmZlcikucGlwZShyZXNwb25zZSk7XG4gICAgfSwgY29udGV4dCk7XG4gIH0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGltYWdlTWFwUE5HO1xuXG5mdW5jdGlvbiBjcmVhdGVJbWFnZU1hcChkaW1lbnNpb24sIG92ZXJsYXlJbWFnZVNpemUsICBjYWxsYmFjaykge1xuICBjb25zdCB3aWR0aCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGhlaWdodCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGNoYW5uZWxzID0gNCxcbiAgICAgICAgYmFja2dyb3VuZCA9IHsgcjogMCwgZzogMCwgYjogMCwgYWxwaGE6IDAgfSxcbiAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICB3aWR0aDogd2lkdGgsXG4gICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgY2hhbm5lbHM6IGNoYW5uZWxzLFxuICAgICAgICAgIGJhY2tncm91bmQ6IGJhY2tncm91bmRcbiAgICAgICAgfSxcbiAgICAgICAgaW1hZ2VNYXAgPSBzaGFycCh7XG4gICAgICAgICAgY3JlYXRlOiBvcHRpb25zIC8vL1xuICAgICAgICB9KTtcblxuICBpbWFnZU1hcFxuICAgIC5wbmcoKVxuICAgIC50b0J1ZmZlcigpXG4gICAgLnRoZW4oZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICAgIGNhbGxiYWNrKGltYWdlQnVmZmVyKVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBvdmVybGF5Q2FsbGJhY2sobmV4dCwgZG9uZSwgY29udGV4dCwgaW5kZXgpIHtcbiAgY29uc3QgeyBuYW1lcywgZGltZW5zaW9uLCBpbWFnZUJ1ZmZlciwgb3ZlcmxheUltYWdlU2l6ZSwgaW1hZ2VEaXJlY3RvcnlQYXRoIH0gPSBjb250ZXh0LFxuICAgICAgICBuYW1lc0xlbmd0aCA9IG5hbWVzLmxlbmd0aCxcbiAgICAgICAgbGFzdEluZGV4ID0gbmFtZXNMZW5ndGggLSAxO1xuXG4gIGlmIChpbmRleCA+IGxhc3RJbmRleCkge1xuICAgIGRvbmUoKTtcbiAgICBcbiAgICByZXR1cm47XG4gIH1cbiAgXG4gIGNvbnN0IG5hbWUgPSBuYW1lc1tpbmRleF0sXG4gICAgICAgIHBhdGggPSBgJHtpbWFnZURpcmVjdG9yeVBhdGh9LyR7bmFtZX1gO1xuXG4gIHJlc2l6ZUltYWdlKHBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIGZ1bmN0aW9uKHJlc2l6ZWRJbWFnZUJ1ZmZlcikge1xuICAgIGNvbnN0IHRvcCA9ICgoZGltZW5zaW9uIC0gMSkgLSBNYXRoLmZsb29yKGluZGV4IC8gZGltZW5zaW9uKSApICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgICBsZWZ0ID0gKGluZGV4ICUgZGltZW5zaW9uKSAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHRvcDogdG9wLFxuICAgICAgICAgICAgbGVmdDogbGVmdFxuICAgICAgICAgIH07XG5cbiAgICBzaGFycChpbWFnZUJ1ZmZlcilcbiAgICAgIC5vdmVybGF5V2l0aChyZXNpemVkSW1hZ2VCdWZmZXIsIG9wdGlvbnMpXG4gICAgICAudG9CdWZmZXIoKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgICAgaW1hZ2VCdWZmZXI6IGltYWdlQnVmZmVyXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVzaXplSW1hZ2UocGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgY2FsbGJhY2spIHtcbiAgY29uc3Qgd2lkdGggPSBvdmVybGF5SW1hZ2VTaXplLCAvLy9cbiAgICAgICAgaGVpZ2h0ID0gb3ZlcmxheUltYWdlU2l6ZTsgIC8vL1xuICBcbiAgc2hhcnAocGF0aClcbiAgICAucmVzaXplKHdpZHRoLCBoZWlnaHQpXG4gICAgLnRvQnVmZmVyKClcbiAgICAudGhlbihmdW5jdGlvbihpbWFnZUJ1ZmZlcikge1xuICAgICAgY29uc3QgcmVzaXplZEltYWdlQnVmZmVyID0gaW1hZ2VCdWZmZXI7IC8vL1xuICAgICAgXG4gICAgICBjYWxsYmFjayhyZXNpemVkSW1hZ2VCdWZmZXIpO1xuICAgIH0pO1xufVxuIl19