'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var namesUtilities = require('./utilities/names');

var asynchronousUtilities = necessary.asynchronousUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory,
    removeHiddenNames = namesUtilities.removeHiddenNames,
    dimensionFromNames = namesUtilities.dimensionFromNames;


function imageMapPNG(names, imageDirectoryPath, overlayImageSize, response) {
  var namesLength = names.length;

  if (namesLength === 0) {
    names = readDirectory(imageDirectoryPath);
  }

  names = removeHiddenNames(names);

  var dimension = dimensionFromNames(names);

  createImageMap(dimension, overlayImageSize, function (imageBuffer) {
    var context = {
      names: names,
      dimension: dimension,
      imageBuffer: imageBuffer,
      overlayImageSize: overlayImageSize,
      imageDirectoryPath: imageDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var imageBuffer = context.imageBuffer;


      sharp(imageBuffer).pipe(response);
    }, context);
  });
}

module.exports = imageMapPNG;

function createImageMap(dimension, overlayImageSize, callback) {
  var width = dimension * overlayImageSize,
      height = dimension * overlayImageSize,
      alpha = 0,
      channels = 4,
      r = 0,
      g = 0,
      b = 0,
      background = {
    r: r,
    g: g,
    b: b,
    alpha: alpha
  },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      create = options,
      ///
  imageMap = sharp({
    create: create
  });

  imageMap.png().toBuffer().then(function (imageBuffer) {
    callback(imageBuffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      dimension = context.dimension,
      imageBuffer = context.imageBuffer,
      overlayImageSize = context.overlayImageSize,
      imageDirectoryPath = context.imageDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = imageDirectoryPath + '/' + name;

  resizeImage(path, overlayImageSize, function (resizedImageBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayImageSize,
        left = index % dimension * overlayImageSize,
        options = {
      top: top,
      left: left
    };

    sharp(imageBuffer).overlayWith(resizedImageBuffer, options).toBuffer().then(function (imageBuffer) {
      Object.assign(context, {
        imageBuffer: imageBuffer
      });

      next();
    });
  });
}

function resizeImage(path, overlayImageSize, callback) {
  var width = overlayImageSize,
      ///
  height = overlayImageSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (imageBuffer) {
    var resizedImageBuffer = imageBuffer; ///

    callback(resizedImageBuffer);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9pbWFnZU1hcFBORy5qcyJdLCJuYW1lcyI6WyJzaGFycCIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJuYW1lc1V0aWxpdGllcyIsImFzeW5jaHJvbm91c1V0aWxpdGllcyIsImZpbGVTeXN0ZW1VdGlsaXRpZXMiLCJ3aGlsc3QiLCJyZWFkRGlyZWN0b3J5IiwicmVtb3ZlSGlkZGVuTmFtZXMiLCJkaW1lbnNpb25Gcm9tTmFtZXMiLCJpbWFnZU1hcFBORyIsIm5hbWVzIiwiaW1hZ2VEaXJlY3RvcnlQYXRoIiwib3ZlcmxheUltYWdlU2l6ZSIsInJlc3BvbnNlIiwibmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJkaW1lbnNpb24iLCJjcmVhdGVJbWFnZU1hcCIsImltYWdlQnVmZmVyIiwiY29udGV4dCIsIm92ZXJsYXlDYWxsYmFjayIsIndyaXRlSGVhZCIsInBpcGUiLCJtb2R1bGUiLCJleHBvcnRzIiwiY2FsbGJhY2siLCJ3aWR0aCIsImhlaWdodCIsImFscGhhIiwiY2hhbm5lbHMiLCJyIiwiZyIsImIiLCJiYWNrZ3JvdW5kIiwib3B0aW9ucyIsImNyZWF0ZSIsImltYWdlTWFwIiwicG5nIiwidG9CdWZmZXIiLCJ0aGVuIiwibmV4dCIsImRvbmUiLCJpbmRleCIsImxhc3RJbmRleCIsIm5hbWUiLCJwYXRoIiwicmVzaXplSW1hZ2UiLCJyZXNpemVkSW1hZ2VCdWZmZXIiLCJ0b3AiLCJNYXRoIiwiZmxvb3IiLCJsZWZ0Iiwib3ZlcmxheVdpdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJyZXNpemUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFFBQVFDLFFBQVEsT0FBUixDQUFkO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCOztBQUdBLElBQU1FLGlCQUFpQkYsUUFBUSxtQkFBUixDQUF2Qjs7SUFFUUcscUIsR0FBK0NGLFMsQ0FBL0NFLHFCO0lBQXVCQyxtQixHQUF3QkgsUyxDQUF4QkcsbUI7SUFDdkJDLE0sR0FBV0YscUIsQ0FB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U21DLGtCQUFULEVBQTZCO0FBQy9ELFFBQU1DLE1BQU0sQ0FBRWhDLFlBQVksQ0FBYixHQUFrQmlDLEtBQUtDLEtBQUwsQ0FBV1IsUUFBUTFCLFNBQW5CLENBQW5CLElBQXFESixnQkFBakU7QUFBQSxRQUNNdUMsT0FBUVQsUUFBUTFCLFNBQVQsR0FBc0JKLGdCQURuQztBQUFBLFFBRU1zQixVQUFVO0FBQ1JjLFdBQUtBLEdBREc7QUFFUkcsWUFBTUE7QUFGRSxLQUZoQjs7QUFPQXBELFVBQU1tQixXQUFOLEVBQ0drQyxXQURILENBQ2VMLGtCQURmLEVBQ21DYixPQURuQyxFQUVHSSxRQUZILEdBR0dDLElBSEgsQ0FHUSxVQUFTckIsV0FBVCxFQUFzQjtBQUMxQm1DLGFBQU9DLE1BQVAsQ0FBY25DLE9BQWQsRUFBdUI7QUFDckJELHFCQUFhQTtBQURRLE9BQXZCOztBQUlBc0I7QUFDRCxLQVRIO0FBVUQsR0FsQkQ7QUFtQkQ7O0FBRUQsU0FBU00sV0FBVCxDQUFxQkQsSUFBckIsRUFBMkJqQyxnQkFBM0IsRUFBNkNhLFFBQTdDLEVBQXVEO0FBQ3JELE1BQU1DLFFBQVFkLGdCQUFkO0FBQUEsTUFBZ0M7QUFDMUJlLFdBQVNmLGdCQURmLENBRHFELENBRW5COztBQUVsQ2IsUUFBTThDLElBQU4sRUFDR1UsTUFESCxDQUNVN0IsS0FEVixFQUNpQkMsTUFEakIsRUFFR1csUUFGSCxHQUdHQyxJQUhILENBR1EsVUFBU3JCLFdBQVQsRUFBc0I7QUFDMUIsUUFBTTZCLHFCQUFxQjdCLFdBQTNCLENBRDBCLENBQ2M7O0FBRXhDTyxhQUFTc0Isa0JBQVQ7QUFDRCxHQVBIO0FBUUQiLCJmaWxlIjoiaW1hZ2VNYXBQTkcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHNoYXJwID0gcmVxdWlyZSgnc2hhcnAnKSxcbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBuYW1lc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL25hbWVzJyk7XG5cbmNvbnN0IHsgYXN5bmNocm9ub3VzVXRpbGl0aWVzLCBmaWxlU3lzdGVtVXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IHdoaWxzdCB9ID0gYXN5bmNocm9ub3VzVXRpbGl0aWVzLFxuICAgICAgeyByZWFkRGlyZWN0b3J5IH0gPSBmaWxlU3lzdGVtVXRpbGl0aWVzLFxuICAgICAgeyByZW1vdmVIaWRkZW5OYW1lcywgZGltZW5zaW9uRnJvbU5hbWVzIH0gPSBuYW1lc1V0aWxpdGllcztcblxuZnVuY3Rpb24gaW1hZ2VNYXBQTkcobmFtZXMsIGltYWdlRGlyZWN0b3J5UGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgcmVzcG9uc2UpIHtcblx0Y29uc3QgbmFtZXNMZW5ndGggPSBuYW1lcy5sZW5ndGg7XG5cblx0aWYgKG5hbWVzTGVuZ3RoID09PSAwKSB7XG5cdFx0bmFtZXMgPSByZWFkRGlyZWN0b3J5KGltYWdlRGlyZWN0b3J5UGF0aCk7XG5cdH1cblxuXHRuYW1lcyA9IHJlbW92ZUhpZGRlbk5hbWVzKG5hbWVzKTtcblxuXHRjb25zdCBkaW1lbnNpb24gPSBkaW1lbnNpb25Gcm9tTmFtZXMobmFtZXMpO1xuXG4gIGNyZWF0ZUltYWdlTWFwKGRpbWVuc2lvbiwgb3ZlcmxheUltYWdlU2l6ZSwgZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgbmFtZXMsXG4gICAgICBkaW1lbnNpb24sXG4gICAgICBpbWFnZUJ1ZmZlcixcbiAgICAgIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICBpbWFnZURpcmVjdG9yeVBhdGhcbiAgICB9O1xuICAgIFxuICAgIHdoaWxzdChvdmVybGF5Q2FsbGJhY2ssIGZ1bmN0aW9uKCkge1xuICAgICAgcmVzcG9uc2Uud3JpdGVIZWFkKDIwMCwgeydDb250ZW50LVR5cGUnOiAnaW1hZ2UvcG5nOyBjaGFyc2V0PXV0Zi04J30pO1xuXG4gICAgICBjb25zdCB7IGltYWdlQnVmZmVyIH0gPSBjb250ZXh0O1xuXG4gICAgICBzaGFycChpbWFnZUJ1ZmZlcikucGlwZShyZXNwb25zZSk7XG4gICAgfSwgY29udGV4dCk7XG4gIH0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGltYWdlTWFwUE5HO1xuXG5mdW5jdGlvbiBjcmVhdGVJbWFnZU1hcChkaW1lbnNpb24sIG92ZXJsYXlJbWFnZVNpemUsICBjYWxsYmFjaykge1xuICBjb25zdCB3aWR0aCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGhlaWdodCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG5cdFx0XHQgIGFscGhhID0gMCxcbiAgICAgICAgY2hhbm5lbHMgPSA0LFxuXHRcdFx0ICByID0gMCxcblx0XHRcdCAgZyA9IDAsXG5cdFx0XHQgIGIgPSAwLFxuICAgICAgICBiYWNrZ3JvdW5kID0ge1xuICBcdCAgICAgIHIsXG5cdCAgICAgICAgZyxcblx0ICAgICAgICBiLFxuXHQgICAgICAgIGFscGhhXG4gICAgICAgIH0sXG4gICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgd2lkdGgsXG4gICAgICAgICAgaGVpZ2h0LFxuICAgICAgICAgIGNoYW5uZWxzLFxuICAgICAgICAgIGJhY2tncm91bmRcbiAgICAgICAgfSxcblx0XHRcdCAgY3JlYXRlID0gb3B0aW9ucywgLy8vXG4gICAgICAgIGltYWdlTWFwID0gc2hhcnAoe1xuICAgICAgICAgIGNyZWF0ZVxuICAgICAgICB9KTtcblxuICBpbWFnZU1hcFxuICAgIC5wbmcoKVxuICAgIC50b0J1ZmZlcigpXG4gICAgLnRoZW4oZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICAgIGNhbGxiYWNrKGltYWdlQnVmZmVyKVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBvdmVybGF5Q2FsbGJhY2sobmV4dCwgZG9uZSwgY29udGV4dCwgaW5kZXgpIHtcbiAgY29uc3QgeyBuYW1lcywgZGltZW5zaW9uLCBpbWFnZUJ1ZmZlciwgb3ZlcmxheUltYWdlU2l6ZSwgaW1hZ2VEaXJlY3RvcnlQYXRoIH0gPSBjb250ZXh0LFxuICAgICAgICBuYW1lc0xlbmd0aCA9IG5hbWVzLmxlbmd0aCxcbiAgICAgICAgbGFzdEluZGV4ID0gbmFtZXNMZW5ndGggLSAxO1xuXG4gIGlmIChpbmRleCA+IGxhc3RJbmRleCkge1xuICAgIGRvbmUoKTtcbiAgICBcbiAgICByZXR1cm47XG4gIH1cbiAgXG4gIGNvbnN0IG5hbWUgPSBuYW1lc1tpbmRleF0sXG4gICAgICAgIHBhdGggPSBgJHtpbWFnZURpcmVjdG9yeVBhdGh9LyR7bmFtZX1gO1xuXG4gIHJlc2l6ZUltYWdlKHBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIGZ1bmN0aW9uKHJlc2l6ZWRJbWFnZUJ1ZmZlcikge1xuICAgIGNvbnN0IHRvcCA9ICgoZGltZW5zaW9uIC0gMSkgLSBNYXRoLmZsb29yKGluZGV4IC8gZGltZW5zaW9uKSApICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgICBsZWZ0ID0gKGluZGV4ICUgZGltZW5zaW9uKSAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHRvcDogdG9wLFxuICAgICAgICAgICAgbGVmdDogbGVmdFxuICAgICAgICAgIH07XG5cbiAgICBzaGFycChpbWFnZUJ1ZmZlcilcbiAgICAgIC5vdmVybGF5V2l0aChyZXNpemVkSW1hZ2VCdWZmZXIsIG9wdGlvbnMpXG4gICAgICAudG9CdWZmZXIoKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgICAgaW1hZ2VCdWZmZXI6IGltYWdlQnVmZmVyXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVzaXplSW1hZ2UocGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgY2FsbGJhY2spIHtcbiAgY29uc3Qgd2lkdGggPSBvdmVybGF5SW1hZ2VTaXplLCAvLy9cbiAgICAgICAgaGVpZ2h0ID0gb3ZlcmxheUltYWdlU2l6ZTsgIC8vL1xuICBcbiAgc2hhcnAocGF0aClcbiAgICAucmVzaXplKHdpZHRoLCBoZWlnaHQpXG4gICAgLnRvQnVmZmVyKClcbiAgICAudGhlbihmdW5jdGlvbihpbWFnZUJ1ZmZlcikge1xuICAgICAgY29uc3QgcmVzaXplZEltYWdlQnVmZmVyID0gaW1hZ2VCdWZmZXI7IC8vL1xuICAgICAgXG4gICAgICBjYWxsYmFjayhyZXNpemVkSW1hZ2VCdWZmZXIpO1xuICAgIH0pO1xufVxuIl19