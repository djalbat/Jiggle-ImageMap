'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var miscellaneousUtilities = necessary.miscellaneousUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    rc = miscellaneousUtilities.rc,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory;


function png(textureDirectoryPath, overlayTextureSize, response) {
  var names = readDirectory(textureDirectoryPath),
      dimension = dimensionFromNames(names);

  createTextureMap(dimension, overlayTextureSize, function (buffer) {
    var context = {
      buffer: buffer,
      names: names,
      dimension: dimension,
      overlayTextureSize: overlayTextureSize,
      textureDirectoryPath: textureDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var buffer = context.buffer;


      sharp(buffer).pipe(response);
    }, context);
  });
}

function json(textureDirectoryPath) {
  var names = readDirectory(textureDirectoryPath),
      dimension = dimensionFromNames(names),
      json = names.reduce(function (json, name, index) {
    var left = index % dimension / dimension,
        bottom = Math.floor(index / dimension) / dimension,
        width = 1 / dimension,
        height = 1 / dimension;

    json[name] = {
      left: left,
      bottom: bottom,
      width: width,
      height: height
    };

    return json;
  }, {});

  return json;
}

module.exports = {
  png: png,
  json: json
};

function createTextureMap(dimension, overlayTextureSize, callback) {
  var width = dimension * overlayTextureSize,
      height = dimension * overlayTextureSize,
      channels = 4,
      background = { r: 0, g: 0, b: 0, alpha: 0 },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      textureMap = sharp({
    create: options ///
  });

  textureMap.png().toBuffer().then(function (buffer) {
    callback(buffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      buffer = context.buffer,
      dimension = context.dimension,
      overlayTextureSize = context.overlayTextureSize,
      textureDirectoryPath = context.textureDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = textureDirectoryPath + '/' + name;

  resizeTexture(path, overlayTextureSize, function (resizedTextureBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayTextureSize,
        left = index % dimension * overlayTextureSize,
        options = {
      top: top,
      left: left
    };

    sharp(buffer).overlayWith(resizedTextureBuffer, options).toBuffer().then(function (buffer) {
      Object.assign(context, {
        buffer: buffer
      });

      next();
    });
  });
}

function resizeTexture(path, overlayTextureSize, callback) {
  var width = overlayTextureSize,
      ///
  height = overlayTextureSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (buffer) {
    var resizedTextureBuffer = buffer; ///

    callback(resizedTextureBuffer);
  });
}

function dimensionFromNames(names) {
  var namesLength = names.length,
      dimension = Math.ceil(Math.sqrt(namesLength)); ///

  return dimension;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi90ZXh0dXJlTWFwLmpzIl0sIm5hbWVzIjpbInNoYXJwIiwicmVxdWlyZSIsIm5lY2Vzc2FyeSIsIm1pc2NlbGxhbmVvdXNVdGlsaXRpZXMiLCJhc3luY2hyb25vdXNVdGlsaXRpZXMiLCJmaWxlU3lzdGVtVXRpbGl0aWVzIiwicmMiLCJ3aGlsc3QiLCJyZWFkRGlyZWN0b3J5IiwicG5nIiwidGV4dHVyZURpcmVjdG9yeVBhdGgiLCJvdmVybGF5VGV4dHVyZVNpemUiLCJyZXNwb25zZSIsIm5hbWVzIiwiZGltZW5zaW9uIiwiZGltZW5zaW9uRnJvbU5hbWVzIiwiY3JlYXRlVGV4dHVyZU1hcCIsImJ1ZmZlciIsImNvbnRleHQiLCJvdmVybGF5Q2FsbGJhY2siLCJ3cml0ZUhlYWQiLCJwaXBlIiwianNvbiIsInJlZHVjZSIsIm5hbWUiLCJpbmRleCIsImxlZnQiLCJib3R0b20iLCJNYXRoIiwiZmxvb3IiLCJ3aWR0aCIsImhlaWdodCIsIm1vZHVsZSIsImV4cG9ydHMiLCJjYWxsYmFjayIsImNoYW5uZWxzIiwiYmFja2dyb3VuZCIsInIiLCJnIiwiYiIsImFscGhhIiwib3B0aW9ucyIsInRleHR1cmVNYXAiLCJjcmVhdGUiLCJ0b0J1ZmZlciIsInRoZW4iLCJuZXh0IiwiZG9uZSIsIm5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwibGFzdEluZGV4IiwicGF0aCIsInJlc2l6ZVRleHR1cmUiLCJyZXNpemVkVGV4dHVyZUJ1ZmZlciIsInRvcCIsIm92ZXJsYXlXaXRoIiwiT2JqZWN0IiwiYXNzaWduIiwicmVzaXplIiwiY2VpbCIsInNxcnQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFFBQVFDLFFBQVEsT0FBUixDQUFkO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCOztJQUdRRSxzQixHQUF1RUQsUyxDQUF2RUMsc0I7SUFBd0JDLHFCLEdBQStDRixTLENBQS9DRSxxQjtJQUF1QkMsbUIsR0FBd0JILFMsQ0FBeEJHLG1CO0lBQy9D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QSxNQUFrQztBQUM1Qm9CLFdBQVNwQixrQkFEZixDQUR5RCxDQUVyQjs7QUFFcENYLFFBQU1tRCxJQUFOLEVBQ0dPLE1BREgsQ0FDVTVCLEtBRFYsRUFDaUJDLE1BRGpCLEVBRUdhLFFBRkgsR0FHR0MsSUFISCxDQUdRLFVBQVM1QixNQUFULEVBQWlCO0FBQ3JCLFFBQU1vQyx1QkFBdUJwQyxNQUE3QixDQURxQixDQUNnQjs7QUFFckNpQixhQUFTbUIsb0JBQVQ7QUFDRCxHQVBIO0FBUUQ7O0FBRUQsU0FBU3RDLGtCQUFULENBQTRCRixLQUE1QixFQUFtQztBQUNqQyxNQUFNbUMsY0FBY25DLE1BQU1vQyxNQUExQjtBQUFBLE1BQ01uQyxZQUFZYyxLQUFLK0IsSUFBTCxDQUFVL0IsS0FBS2dDLElBQUwsQ0FBVVosV0FBVixDQUFWLENBRGxCLENBRGlDLENBRW9COztBQUVyRCxTQUFPbEMsU0FBUDtBQUNEIiwiZmlsZSI6InRleHR1cmVNYXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHNoYXJwID0gcmVxdWlyZSgnc2hhcnAnKSxcbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCB7IG1pc2NlbGxhbmVvdXNVdGlsaXRpZXMsIGFzeW5jaHJvbm91c1V0aWxpdGllcywgZmlsZVN5c3RlbVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyByYyB9ID0gbWlzY2VsbGFuZW91c1V0aWxpdGllcyxcbiAgICAgIHsgd2hpbHN0IH0gPSBhc3luY2hyb25vdXNVdGlsaXRpZXMsXG4gICAgICB7IHJlYWREaXJlY3RvcnkgfSA9IGZpbGVTeXN0ZW1VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIHBuZyh0ZXh0dXJlRGlyZWN0b3J5UGF0aCwgb3ZlcmxheVRleHR1cmVTaXplLCByZXNwb25zZSkge1xuICBjb25zdCBuYW1lcyA9IHJlYWREaXJlY3RvcnkodGV4dHVyZURpcmVjdG9yeVBhdGgpLFxuICAgICAgICBkaW1lbnNpb24gPSBkaW1lbnNpb25Gcm9tTmFtZXMobmFtZXMpO1xuXG4gIGNyZWF0ZVRleHR1cmVNYXAoZGltZW5zaW9uLCBvdmVybGF5VGV4dHVyZVNpemUsIGZ1bmN0aW9uKGJ1ZmZlcikge1xuICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICBidWZmZXI6IGJ1ZmZlcixcbiAgICAgIG5hbWVzOiBuYW1lcyxcbiAgICAgIGRpbWVuc2lvbjogZGltZW5zaW9uLFxuICAgICAgb3ZlcmxheVRleHR1cmVTaXplOiBvdmVybGF5VGV4dHVyZVNpemUsXG4gICAgICB0ZXh0dXJlRGlyZWN0b3J5UGF0aDogdGV4dHVyZURpcmVjdG9yeVBhdGhcbiAgICB9O1xuICAgIFxuICAgIHdoaWxzdChvdmVybGF5Q2FsbGJhY2ssIGZ1bmN0aW9uKCkge1xuICAgICAgcmVzcG9uc2Uud3JpdGVIZWFkKDIwMCwgeydDb250ZW50LVR5cGUnOiAnaW1hZ2UvcG5nOyBjaGFyc2V0PXV0Zi04J30pO1xuXG4gICAgICBjb25zdCB7IGJ1ZmZlciB9ID0gY29udGV4dDtcblxuICAgICAgc2hhcnAoYnVmZmVyKS5waXBlKHJlc3BvbnNlKTtcbiAgICB9LCBjb250ZXh0KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGpzb24odGV4dHVyZURpcmVjdG9yeVBhdGgpIHtcbiAgY29uc3QgbmFtZXMgPSByZWFkRGlyZWN0b3J5KHRleHR1cmVEaXJlY3RvcnlQYXRoKSxcbiAgICAgICAgZGltZW5zaW9uID0gZGltZW5zaW9uRnJvbU5hbWVzKG5hbWVzKSxcbiAgICAgICAganNvbiA9IG5hbWVzLnJlZHVjZShmdW5jdGlvbihqc29uLCBuYW1lLCBpbmRleCkge1xuICAgICAgICAgIGNvbnN0IGxlZnQgPSAoaW5kZXggJSBkaW1lbnNpb24pIC8gZGltZW5zaW9uLFxuICAgICAgICAgICAgICAgIGJvdHRvbSA9IE1hdGguZmxvb3IoaW5kZXggLyBkaW1lbnNpb24pIC8gZGltZW5zaW9uLFxuICAgICAgICAgICAgICAgIHdpZHRoID0gMSAvIGRpbWVuc2lvbixcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSAxIC8gZGltZW5zaW9uO1xuXG4gICAgICAgICAganNvbltuYW1lXSA9IHtcbiAgICAgICAgICAgIGxlZnQ6IGxlZnQsXG4gICAgICAgICAgICBib3R0b206IGJvdHRvbSxcbiAgICAgICAgICAgIHdpZHRoOiB3aWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHJldHVybiBqc29uO1xuICAgICAgICB9LCB7fSk7XG4gICAgICAgIFxuICByZXR1cm4ganNvbjtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHBuZzogcG5nLFxuICBqc29uOiBqc29uXG59O1xuXG5mdW5jdGlvbiBjcmVhdGVUZXh0dXJlTWFwKGRpbWVuc2lvbiwgb3ZlcmxheVRleHR1cmVTaXplLCAgY2FsbGJhY2spIHtcbiAgY29uc3Qgd2lkdGggPSBkaW1lbnNpb24gKiBvdmVybGF5VGV4dHVyZVNpemUsXG4gICAgICAgIGhlaWdodCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlUZXh0dXJlU2l6ZSxcbiAgICAgICAgY2hhbm5lbHMgPSA0LFxuICAgICAgICBiYWNrZ3JvdW5kID0geyByOiAwLCBnOiAwLCBiOiAwLCBhbHBoYTogMCB9LFxuICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgIHdpZHRoOiB3aWR0aCxcbiAgICAgICAgICBoZWlnaHQ6IGhlaWdodCxcbiAgICAgICAgICBjaGFubmVsczogY2hhbm5lbHMsXG4gICAgICAgICAgYmFja2dyb3VuZDogYmFja2dyb3VuZFxuICAgICAgICB9LFxuICAgICAgICB0ZXh0dXJlTWFwID0gc2hhcnAoe1xuICAgICAgICAgIGNyZWF0ZTogb3B0aW9ucyAvLy9cbiAgICAgICAgfSk7XG5cbiAgdGV4dHVyZU1hcFxuICAgIC5wbmcoKVxuICAgIC50b0J1ZmZlcigpXG4gICAgLnRoZW4oZnVuY3Rpb24oYnVmZmVyKSB7XG4gICAgICBjYWxsYmFjayhidWZmZXIpXG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIG92ZXJsYXlDYWxsYmFjayhuZXh0LCBkb25lLCBjb250ZXh0LCBpbmRleCkge1xuICBjb25zdCB7IG5hbWVzLCBidWZmZXIsIGRpbWVuc2lvbiwgb3ZlcmxheVRleHR1cmVTaXplLCB0ZXh0dXJlRGlyZWN0b3J5UGF0aCB9ID0gY29udGV4dCxcbiAgICAgICAgbmFtZXNMZW5ndGggPSBuYW1lcy5sZW5ndGgsXG4gICAgICAgIGxhc3RJbmRleCA9IG5hbWVzTGVuZ3RoIC0gMTtcblxuICBpZiAoaW5kZXggPiBsYXN0SW5kZXgpIHtcbiAgICBkb25lKCk7XG4gICAgXG4gICAgcmV0dXJuO1xuICB9XG4gIFxuICBjb25zdCBuYW1lID0gbmFtZXNbaW5kZXhdLFxuICAgICAgICBwYXRoID0gYCR7dGV4dHVyZURpcmVjdG9yeVBhdGh9LyR7bmFtZX1gO1xuXG4gIHJlc2l6ZVRleHR1cmUocGF0aCwgb3ZlcmxheVRleHR1cmVTaXplLCBmdW5jdGlvbihyZXNpemVkVGV4dHVyZUJ1ZmZlcikge1xuICAgIGNvbnN0IHRvcCA9ICgoZGltZW5zaW9uIC0gMSkgLSBNYXRoLmZsb29yKGluZGV4IC8gZGltZW5zaW9uKSApICogb3ZlcmxheVRleHR1cmVTaXplLFxuICAgICAgICAgIGxlZnQgPSAoaW5kZXggJSBkaW1lbnNpb24pICogb3ZlcmxheVRleHR1cmVTaXplLFxuICAgICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICB0b3A6IHRvcCxcbiAgICAgICAgICAgIGxlZnQ6IGxlZnRcbiAgICAgICAgICB9O1xuXG4gICAgc2hhcnAoYnVmZmVyKVxuICAgICAgLm92ZXJsYXlXaXRoKHJlc2l6ZWRUZXh0dXJlQnVmZmVyLCBvcHRpb25zKVxuICAgICAgLnRvQnVmZmVyKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uKGJ1ZmZlcikge1xuICAgICAgICBPYmplY3QuYXNzaWduKGNvbnRleHQsIHtcbiAgICAgICAgICBidWZmZXI6IGJ1ZmZlclxuICAgICAgICB9KTtcblxuICAgICAgICBuZXh0KCk7XG4gICAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlc2l6ZVRleHR1cmUocGF0aCwgb3ZlcmxheVRleHR1cmVTaXplLCBjYWxsYmFjaykge1xuICBjb25zdCB3aWR0aCA9IG92ZXJsYXlUZXh0dXJlU2l6ZSwgLy8vXG4gICAgICAgIGhlaWdodCA9IG92ZXJsYXlUZXh0dXJlU2l6ZTsgIC8vL1xuICBcbiAgc2hhcnAocGF0aClcbiAgICAucmVzaXplKHdpZHRoLCBoZWlnaHQpXG4gICAgLnRvQnVmZmVyKClcbiAgICAudGhlbihmdW5jdGlvbihidWZmZXIpIHtcbiAgICAgIGNvbnN0IHJlc2l6ZWRUZXh0dXJlQnVmZmVyID0gYnVmZmVyOyAvLy9cbiAgICAgIFxuICAgICAgY2FsbGJhY2socmVzaXplZFRleHR1cmVCdWZmZXIpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBkaW1lbnNpb25Gcm9tTmFtZXMobmFtZXMpIHtcbiAgY29uc3QgbmFtZXNMZW5ndGggPSBuYW1lcy5sZW5ndGgsXG4gICAgICAgIGRpbWVuc2lvbiA9IE1hdGguY2VpbChNYXRoLnNxcnQobmFtZXNMZW5ndGgpKTsgLy8vXG5cbiAgcmV0dXJuIGRpbWVuc2lvbjtcbn1cbiJdfQ==