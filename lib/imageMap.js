'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var miscellaneousUtilities = necessary.miscellaneousUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    rc = miscellaneousUtilities.rc,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory;


function png(imageDirectoryPath, overlayImageSize, response) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names);

  createImageMap(dimension, overlayImageSize, function (imageBuffer) {
    var context = {
      names: names,
      dimension: dimension,
      imageBuffer: imageBuffer,
      overlayImageSize: overlayImageSize,
      imageDirectoryPath: imageDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var imageBuffer = context.imageBuffer;


      sharp(imageBuffer).pipe(response);
    }, context);
  });
}

function json(imageDirectoryPath) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names),
      json = names.reduce(function (json, name, index) {
    var left = index % dimension / dimension,
        bottom = Math.floor(index / dimension) / dimension,
        width = 1 / dimension,
        height = 1 / dimension;

    json[name] = {
      left: left,
      bottom: bottom,
      width: width,
      height: height
    };

    return json;
  }, {});

  return json;
}

module.exports = {
  png: png,
  json: json
};

function createImageMap(dimension, overlayImageSize, callback) {
  var width = dimension * overlayImageSize,
      height = dimension * overlayImageSize,
      channels = 4,
      background = { r: 0, g: 0, b: 0, alpha: 0 },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      textureMap = sharp({
    create: options ///
  });

  textureMap.png().toBuffer().then(function (imageBuffer) {
    callback(imageBuffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      dimension = context.dimension,
      imageBuffer = context.imageBuffer,
      overlayImageSize = context.overlayImageSize,
      imageDirectoryPath = context.imageDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = imageDirectoryPath + '/' + name;

  resizeImage(path, overlayImageSize, function (resizedImageBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayImageSize,
        left = index % dimension * overlayImageSize,
        options = {
      top: top,
      left: left
    };

    sharp(imageBuffer).overlayWith(resizedImageBuffer, options).toBuffer().then(function (imageBuffer) {
      Object.assign(context, {
        imageBuffer: imageBuffer
      });

      next();
    });
  });
}

function resizeImage(path, overlayImageSize, callback) {
  var width = overlayImageSize,
      ///
  height = overlayImageSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (imageBuffer) {
    var resizedImageBuffer = imageBuffer; ///

    callback(resizedImageBuffer);
  });
}

function dimensionFromNames(names) {
  var namesLength = names.length,
      dimension = Math.ceil(Math.sqrt(namesLength)); ///

  return dimension;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9pbWFnZU1hcC5qcyJdLCJuYW1lcyI6WyJzaGFycCIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJtaXNjZWxsYW5lb3VzVXRpbGl0aWVzIiwiYXN5bmNocm9ub3VzVXRpbGl0aWVzIiwiZmlsZVN5c3RlbVV0aWxpdGllcyIsInJjIiwid2hpbHN0IiwicmVhZERpcmVjdG9yeSIsInBuZyIsImltYWdlRGlyZWN0b3J5UGF0aCIsIm92ZXJsYXlJbWFnZVNpemUiLCJyZXNwb25zZSIsIm5hbWVzIiwiZGltZW5zaW9uIiwiZGltZW5zaW9uRnJvbU5hbWVzIiwiY3JlYXRlSW1hZ2VNYXAiLCJpbWFnZUJ1ZmZlciIsImNvbnRleHQiLCJvdmVybGF5Q2FsbGJhY2siLCJ3cml0ZUhlYWQiLCJwaXBlIiwianNvbiIsInJlZHVjZSIsIm5hbWUiLCJpbmRleCIsImxlZnQiLCJib3R0b20iLCJNYXRoIiwiZmxvb3IiLCJ3aWR0aCIsImhlaWdodCIsIm1vZHVsZSIsImV4cG9ydHMiLCJjYWxsYmFjayIsImNoYW5uZWxzIiwiYmFja2dyb3VuZCIsInIiLCJnIiwiYiIsImFscGhhIiwib3B0aW9ucyIsInRleHR1cmVNYXAiLCJjcmVhdGUiLCJ0b0J1ZmZlciIsInRoZW4iLCJuZXh0IiwiZG9uZSIsIm5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwibGFzdEluZGV4IiwicGF0aCIsInJlc2l6ZUltYWdlIiwicmVzaXplZEltYWdlQnVmZmVyIiwidG9wIiwib3ZlcmxheVdpdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJyZXNpemUiLCJjZWlsIiwic3FydCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsUUFBUUMsUUFBUSxPQUFSLENBQWQ7QUFBQSxJQUNNQyxZQUFZRCxRQUFRLFdBQVIsQ0FEbEI7O0lBR1FFLHNCLEdBQXVFRCxTLENBQXZFQyxzQjtJQUF3QkMscUIsR0FBK0NGLFMsQ0FBL0NFLHFCO0lBQXVCQyxtQixHQUF3QkgsUyxDQUF4QkcsbUI7SUFDL0NDLEUsR0FB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Qm9CLFdBQVNwQixnQkFEZixDQURxRCxDQUVuQjs7QUFFbENYLFFBQU1tRCxJQUFOLEVBQ0dPLE1BREgsQ0FDVTVCLEtBRFYsRUFDaUJDLE1BRGpCLEVBRUdhLFFBRkgsR0FHR0MsSUFISCxDQUdRLFVBQVM1QixXQUFULEVBQXNCO0FBQzFCLFFBQU1vQyxxQkFBcUJwQyxXQUEzQixDQUQwQixDQUNjOztBQUV4Q2lCLGFBQVNtQixrQkFBVDtBQUNELEdBUEg7QUFRRDs7QUFFRCxTQUFTdEMsa0JBQVQsQ0FBNEJGLEtBQTVCLEVBQW1DO0FBQ2pDLE1BQU1tQyxjQUFjbkMsTUFBTW9DLE1BQTFCO0FBQUEsTUFDTW5DLFlBQVljLEtBQUsrQixJQUFMLENBQVUvQixLQUFLZ0MsSUFBTCxDQUFVWixXQUFWLENBQVYsQ0FEbEIsQ0FEaUMsQ0FFb0I7O0FBRXJELFNBQU9sQyxTQUFQO0FBQ0QiLCJmaWxlIjoiaW1hZ2VNYXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHNoYXJwID0gcmVxdWlyZSgnc2hhcnAnKSxcbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCB7IG1pc2NlbGxhbmVvdXNVdGlsaXRpZXMsIGFzeW5jaHJvbm91c1V0aWxpdGllcywgZmlsZVN5c3RlbVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyByYyB9ID0gbWlzY2VsbGFuZW91c1V0aWxpdGllcyxcbiAgICAgIHsgd2hpbHN0IH0gPSBhc3luY2hyb25vdXNVdGlsaXRpZXMsXG4gICAgICB7IHJlYWREaXJlY3RvcnkgfSA9IGZpbGVTeXN0ZW1VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIHBuZyhpbWFnZURpcmVjdG9yeVBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIHJlc3BvbnNlKSB7XG4gIGNvbnN0IG5hbWVzID0gcmVhZERpcmVjdG9yeShpbWFnZURpcmVjdG9yeVBhdGgpLFxuICAgICAgICBkaW1lbnNpb24gPSBkaW1lbnNpb25Gcm9tTmFtZXMobmFtZXMpO1xuXG4gIGNyZWF0ZUltYWdlTWFwKGRpbWVuc2lvbiwgb3ZlcmxheUltYWdlU2l6ZSwgZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgbmFtZXM6IG5hbWVzLFxuICAgICAgZGltZW5zaW9uOiBkaW1lbnNpb24sXG4gICAgICBpbWFnZUJ1ZmZlcjogaW1hZ2VCdWZmZXIsXG4gICAgICBvdmVybGF5SW1hZ2VTaXplOiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgaW1hZ2VEaXJlY3RvcnlQYXRoOiBpbWFnZURpcmVjdG9yeVBhdGhcbiAgICB9O1xuICAgIFxuICAgIHdoaWxzdChvdmVybGF5Q2FsbGJhY2ssIGZ1bmN0aW9uKCkge1xuICAgICAgcmVzcG9uc2Uud3JpdGVIZWFkKDIwMCwgeydDb250ZW50LVR5cGUnOiAnaW1hZ2UvcG5nOyBjaGFyc2V0PXV0Zi04J30pO1xuXG4gICAgICBjb25zdCB7IGltYWdlQnVmZmVyIH0gPSBjb250ZXh0O1xuXG4gICAgICBzaGFycChpbWFnZUJ1ZmZlcikucGlwZShyZXNwb25zZSk7XG4gICAgfSwgY29udGV4dCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBqc29uKGltYWdlRGlyZWN0b3J5UGF0aCkge1xuICBjb25zdCBuYW1lcyA9IHJlYWREaXJlY3RvcnkoaW1hZ2VEaXJlY3RvcnlQYXRoKSxcbiAgICAgICAgZGltZW5zaW9uID0gZGltZW5zaW9uRnJvbU5hbWVzKG5hbWVzKSxcbiAgICAgICAganNvbiA9IG5hbWVzLnJlZHVjZShmdW5jdGlvbihqc29uLCBuYW1lLCBpbmRleCkge1xuICAgICAgICAgIGNvbnN0IGxlZnQgPSAoaW5kZXggJSBkaW1lbnNpb24pIC8gZGltZW5zaW9uLFxuICAgICAgICAgICAgICAgIGJvdHRvbSA9IE1hdGguZmxvb3IoaW5kZXggLyBkaW1lbnNpb24pIC8gZGltZW5zaW9uLFxuICAgICAgICAgICAgICAgIHdpZHRoID0gMSAvIGRpbWVuc2lvbixcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSAxIC8gZGltZW5zaW9uO1xuXG4gICAgICAgICAganNvbltuYW1lXSA9IHtcbiAgICAgICAgICAgIGxlZnQ6IGxlZnQsXG4gICAgICAgICAgICBib3R0b206IGJvdHRvbSxcbiAgICAgICAgICAgIHdpZHRoOiB3aWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHJldHVybiBqc29uO1xuICAgICAgICB9LCB7fSk7XG4gICAgICAgIFxuICByZXR1cm4ganNvbjtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHBuZzogcG5nLFxuICBqc29uOiBqc29uXG59O1xuXG5mdW5jdGlvbiBjcmVhdGVJbWFnZU1hcChkaW1lbnNpb24sIG92ZXJsYXlJbWFnZVNpemUsICBjYWxsYmFjaykge1xuICBjb25zdCB3aWR0aCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGhlaWdodCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGNoYW5uZWxzID0gNCxcbiAgICAgICAgYmFja2dyb3VuZCA9IHsgcjogMCwgZzogMCwgYjogMCwgYWxwaGE6IDAgfSxcbiAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICB3aWR0aDogd2lkdGgsXG4gICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgY2hhbm5lbHM6IGNoYW5uZWxzLFxuICAgICAgICAgIGJhY2tncm91bmQ6IGJhY2tncm91bmRcbiAgICAgICAgfSxcbiAgICAgICAgdGV4dHVyZU1hcCA9IHNoYXJwKHtcbiAgICAgICAgICBjcmVhdGU6IG9wdGlvbnMgLy8vXG4gICAgICAgIH0pO1xuXG4gIHRleHR1cmVNYXBcbiAgICAucG5nKClcbiAgICAudG9CdWZmZXIoKVxuICAgIC50aGVuKGZ1bmN0aW9uKGltYWdlQnVmZmVyKSB7XG4gICAgICBjYWxsYmFjayhpbWFnZUJ1ZmZlcilcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gb3ZlcmxheUNhbGxiYWNrKG5leHQsIGRvbmUsIGNvbnRleHQsIGluZGV4KSB7XG4gIGNvbnN0IHsgbmFtZXMsIGRpbWVuc2lvbiwgaW1hZ2VCdWZmZXIsIG92ZXJsYXlJbWFnZVNpemUsIGltYWdlRGlyZWN0b3J5UGF0aCB9ID0gY29udGV4dCxcbiAgICAgICAgbmFtZXNMZW5ndGggPSBuYW1lcy5sZW5ndGgsXG4gICAgICAgIGxhc3RJbmRleCA9IG5hbWVzTGVuZ3RoIC0gMTtcblxuICBpZiAoaW5kZXggPiBsYXN0SW5kZXgpIHtcbiAgICBkb25lKCk7XG4gICAgXG4gICAgcmV0dXJuO1xuICB9XG4gIFxuICBjb25zdCBuYW1lID0gbmFtZXNbaW5kZXhdLFxuICAgICAgICBwYXRoID0gYCR7aW1hZ2VEaXJlY3RvcnlQYXRofS8ke25hbWV9YDtcblxuICByZXNpemVJbWFnZShwYXRoLCBvdmVybGF5SW1hZ2VTaXplLCBmdW5jdGlvbihyZXNpemVkSW1hZ2VCdWZmZXIpIHtcbiAgICBjb25zdCB0b3AgPSAoKGRpbWVuc2lvbiAtIDEpIC0gTWF0aC5mbG9vcihpbmRleCAvIGRpbWVuc2lvbikgKSAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgICAgbGVmdCA9IChpbmRleCAlIGRpbWVuc2lvbikgKiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICB0b3A6IHRvcCxcbiAgICAgICAgICAgIGxlZnQ6IGxlZnRcbiAgICAgICAgICB9O1xuXG4gICAgc2hhcnAoaW1hZ2VCdWZmZXIpXG4gICAgICAub3ZlcmxheVdpdGgocmVzaXplZEltYWdlQnVmZmVyLCBvcHRpb25zKVxuICAgICAgLnRvQnVmZmVyKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uKGltYWdlQnVmZmVyKSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICAgIGltYWdlQnVmZmVyOiBpbWFnZUJ1ZmZlclxuICAgICAgICB9KTtcblxuICAgICAgICBuZXh0KCk7XG4gICAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlc2l6ZUltYWdlKHBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHdpZHRoID0gb3ZlcmxheUltYWdlU2l6ZSwgLy8vXG4gICAgICAgIGhlaWdodCA9IG92ZXJsYXlJbWFnZVNpemU7ICAvLy9cbiAgXG4gIHNoYXJwKHBhdGgpXG4gICAgLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KVxuICAgIC50b0J1ZmZlcigpXG4gICAgLnRoZW4oZnVuY3Rpb24oaW1hZ2VCdWZmZXIpIHtcbiAgICAgIGNvbnN0IHJlc2l6ZWRJbWFnZUJ1ZmZlciA9IGltYWdlQnVmZmVyOyAvLy9cbiAgICAgIFxuICAgICAgY2FsbGJhY2socmVzaXplZEltYWdlQnVmZmVyKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gZGltZW5zaW9uRnJvbU5hbWVzKG5hbWVzKSB7XG4gIGNvbnN0IG5hbWVzTGVuZ3RoID0gbmFtZXMubGVuZ3RoLFxuICAgICAgICBkaW1lbnNpb24gPSBNYXRoLmNlaWwoTWF0aC5zcXJ0KG5hbWVzTGVuZ3RoKSk7IC8vL1xuXG4gIHJldHVybiBkaW1lbnNpb247XG59XG4iXX0=