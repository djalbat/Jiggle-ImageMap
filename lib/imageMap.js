'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var miscellaneousUtilities = necessary.miscellaneousUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    rc = miscellaneousUtilities.rc,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory;


function png(imageDirectoryPath, overlayImageSize, response) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names);

  createImageMap(dimension, overlayImageSize, function (buffer) {
    var context = {
      buffer: buffer,
      names: names,
      dimension: dimension,
      overlayImageSize: overlayImageSize,
      imageDirectoryPath: imageDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var buffer = context.buffer;


      sharp(buffer).pipe(response);
    }, context);
  });
}

function json(imageDirectoryPath) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names),
      json = names.reduce(function (json, name, index) {
    var left = index % dimension / dimension,
        bottom = Math.floor(index / dimension) / dimension,
        width = 1 / dimension,
        height = 1 / dimension;

    json[name] = {
      left: left,
      bottom: bottom,
      width: width,
      height: height
    };

    return json;
  }, {});

  return json;
}

module.exports = {
  png: png,
  json: json
};

function createImageMap(dimension, overlayImageSize, callback) {
  var width = dimension * overlayImageSize,
      height = dimension * overlayImageSize,
      channels = 4,
      background = { r: 0, g: 0, b: 0, alpha: 0 },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      imageMap = sharp({
    create: options ///
  });

  imageMap.png().toBuffer().then(function (buffer) {
    callback(buffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      buffer = context.buffer,
      dimension = context.dimension,
      overlayImageSize = context.overlayImageSize,
      imageDirectoryPath = context.imageDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = imageDirectoryPath + '/' + name;

  resizeImage(path, overlayImageSize, function (resizedImageBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayImageSize,
        left = index % dimension * overlayImageSize,
        options = {
      top: top,
      left: left
    };

    sharp(buffer).overlayWith(resizedImageBuffer, options).toBuffer().then(function (buffer) {
      Object.assign(context, {
        buffer: buffer
      });

      next();
    });
  });
}

function resizeImage(path, overlayImageSize, callback) {
  var width = overlayImageSize,
      ///
  height = overlayImageSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (buffer) {
    var resizedImageBuffer = buffer; ///

    callback(resizedImageBuffer);
  });
}

function dimensionFromNames(names) {
  var namesLength = names.length,
      dimension = Math.ceil(Math.sqrt(namesLength)); ///

  return dimension;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9pbWFnZU1hcC5qcyJdLCJuYW1lcyI6WyJzaGFycCIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJtaXNjZWxsYW5lb3VzVXRpbGl0aWVzIiwiYXN5bmNocm9ub3VzVXRpbGl0aWVzIiwiZmlsZVN5c3RlbVV0aWxpdGllcyIsInJjIiwid2hpbHN0IiwicmVhZERpcmVjdG9yeSIsInBuZyIsImltYWdlRGlyZWN0b3J5UGF0aCIsIm92ZXJsYXlJbWFnZVNpemUiLCJyZXNwb25zZSIsIm5hbWVzIiwiZGltZW5zaW9uIiwiZGltZW5zaW9uRnJvbU5hbWVzIiwiY3JlYXRlSW1hZ2VNYXAiLCJidWZmZXIiLCJjb250ZXh0Iiwib3ZlcmxheUNhbGxiYWNrIiwid3JpdGVIZWFkIiwicGlwZSIsImpzb24iLCJyZWR1Y2UiLCJuYW1lIiwiaW5kZXgiLCJsZWZ0IiwiYm90dG9tIiwiTWF0aCIsImZsb29yIiwid2lkdGgiLCJoZWlnaHQiLCJtb2R1bGUiLCJleHBvcnRzIiwiY2FsbGJhY2siLCJjaGFubmVscyIsImJhY2tncm91bmQiLCJyIiwiZyIsImIiLCJhbHBoYSIsIm9wdGlvbnMiLCJpbWFnZU1hcCIsImNyZWF0ZSIsInRvQnVmZmVyIiwidGhlbiIsIm5leHQiLCJkb25lIiwibmFtZXNMZW5ndGgiLCJsZW5ndGgiLCJsYXN0SW5kZXgiLCJwYXRoIiwicmVzaXplSW1hZ2UiLCJyZXNpemVkSW1hZ2VCdWZmZXIiLCJ0b3AiLCJvdmVybGF5V2l0aCIsIk9iamVjdCIsImFzc2lnbiIsInJlc2l6ZSIsImNlaWwiLCJzcXJ0Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxRQUFRQyxRQUFRLE9BQVIsQ0FBZDtBQUFBLElBQ01DLFlBQVlELFFBQVEsV0FBUixDQURsQjs7SUFHUUUsc0IsR0FBdUVELFMsQ0FBdkVDLHNCO0lBQXdCQyxxQixHQUErQ0YsUyxDQUEvQ0UscUI7SUFBdUJDLG1CLEdBQXdCSCxTLENBQXhCRyxtQjtJQUMvQ0MsRSxHQUFPSCxzQixD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U3BCLGdCQURmLENBRHFELENBRW5COztBQUVsQ1gsUUFBTW1ELElBQU4sRUFDR08sTUFESCxDQUNVNUIsS0FEVixFQUNpQkMsTUFEakIsRUFFR2EsUUFGSCxHQUdHQyxJQUhILENBR1EsVUFBUzVCLE1BQVQsRUFBaUI7QUFDckIsUUFBTW9DLHFCQUFxQnBDLE1BQTNCLENBRHFCLENBQ2M7O0FBRW5DaUIsYUFBU21CLGtCQUFUO0FBQ0QsR0FQSDtBQVFEOztBQUVELFNBQVN0QyxrQkFBVCxDQUE0QkYsS0FBNUIsRUFBbUM7QUFDakMsTUFBTW1DLGNBQWNuQyxNQUFNb0MsTUFBMUI7QUFBQSxNQUNNbkMsWUFBWWMsS0FBSytCLElBQUwsQ0FBVS9CLEtBQUtnQyxJQUFMLENBQVVaLFdBQVYsQ0FBVixDQURsQixDQURpQyxDQUVvQjs7QUFFckQsU0FBT2xDLFNBQVA7QUFDRCIsImZpbGUiOiJpbWFnZU1hcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3Qgc2hhcnAgPSByZXF1aXJlKCdzaGFycCcpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IHsgbWlzY2VsbGFuZW91c1V0aWxpdGllcywgYXN5bmNocm9ub3VzVXRpbGl0aWVzLCBmaWxlU3lzdGVtVXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IHJjIH0gPSBtaXNjZWxsYW5lb3VzVXRpbGl0aWVzLFxuICAgICAgeyB3aGlsc3QgfSA9IGFzeW5jaHJvbm91c1V0aWxpdGllcyxcbiAgICAgIHsgcmVhZERpcmVjdG9yeSB9ID0gZmlsZVN5c3RlbVV0aWxpdGllcztcblxuZnVuY3Rpb24gcG5nKGltYWdlRGlyZWN0b3J5UGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgcmVzcG9uc2UpIHtcbiAgY29uc3QgbmFtZXMgPSByZWFkRGlyZWN0b3J5KGltYWdlRGlyZWN0b3J5UGF0aCksXG4gICAgICAgIGRpbWVuc2lvbiA9IGRpbWVuc2lvbkZyb21OYW1lcyhuYW1lcyk7XG5cbiAgY3JlYXRlSW1hZ2VNYXAoZGltZW5zaW9uLCBvdmVybGF5SW1hZ2VTaXplLCBmdW5jdGlvbihidWZmZXIpIHtcbiAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgYnVmZmVyOiBidWZmZXIsXG4gICAgICBuYW1lczogbmFtZXMsXG4gICAgICBkaW1lbnNpb246IGRpbWVuc2lvbixcbiAgICAgIG92ZXJsYXlJbWFnZVNpemU6IG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICBpbWFnZURpcmVjdG9yeVBhdGg6IGltYWdlRGlyZWN0b3J5UGF0aFxuICAgIH07XG4gICAgXG4gICAgd2hpbHN0KG92ZXJsYXlDYWxsYmFjaywgZnVuY3Rpb24oKSB7XG4gICAgICByZXNwb25zZS53cml0ZUhlYWQoMjAwLCB7J0NvbnRlbnQtVHlwZSc6ICdpbWFnZS9wbmc7IGNoYXJzZXQ9dXRmLTgnfSk7XG5cbiAgICAgIGNvbnN0IHsgYnVmZmVyIH0gPSBjb250ZXh0O1xuXG4gICAgICBzaGFycChidWZmZXIpLnBpcGUocmVzcG9uc2UpO1xuICAgIH0sIGNvbnRleHQpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24ganNvbihpbWFnZURpcmVjdG9yeVBhdGgpIHtcbiAgY29uc3QgbmFtZXMgPSByZWFkRGlyZWN0b3J5KGltYWdlRGlyZWN0b3J5UGF0aCksXG4gICAgICAgIGRpbWVuc2lvbiA9IGRpbWVuc2lvbkZyb21OYW1lcyhuYW1lcyksXG4gICAgICAgIGpzb24gPSBuYW1lcy5yZWR1Y2UoZnVuY3Rpb24oanNvbiwgbmFtZSwgaW5kZXgpIHtcbiAgICAgICAgICBjb25zdCBsZWZ0ID0gKGluZGV4ICUgZGltZW5zaW9uKSAvIGRpbWVuc2lvbixcbiAgICAgICAgICAgICAgICBib3R0b20gPSBNYXRoLmZsb29yKGluZGV4IC8gZGltZW5zaW9uKSAvIGRpbWVuc2lvbixcbiAgICAgICAgICAgICAgICB3aWR0aCA9IDEgLyBkaW1lbnNpb24sXG4gICAgICAgICAgICAgICAgaGVpZ2h0ID0gMSAvIGRpbWVuc2lvbjtcblxuICAgICAgICAgIGpzb25bbmFtZV0gPSB7XG4gICAgICAgICAgICBsZWZ0OiBsZWZ0LFxuICAgICAgICAgICAgYm90dG9tOiBib3R0b20sXG4gICAgICAgICAgICB3aWR0aDogd2lkdGgsXG4gICAgICAgICAgICBoZWlnaHQ6IGhlaWdodFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXR1cm4ganNvbjtcbiAgICAgICAgfSwge30pO1xuICAgICAgICBcbiAgcmV0dXJuIGpzb247XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBwbmc6IHBuZyxcbiAganNvbjoganNvblxufTtcblxuZnVuY3Rpb24gY3JlYXRlSW1hZ2VNYXAoZGltZW5zaW9uLCBvdmVybGF5SW1hZ2VTaXplLCAgY2FsbGJhY2spIHtcbiAgY29uc3Qgd2lkdGggPSBkaW1lbnNpb24gKiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgICBoZWlnaHQgPSBkaW1lbnNpb24gKiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgICBjaGFubmVscyA9IDQsXG4gICAgICAgIGJhY2tncm91bmQgPSB7IHI6IDAsIGc6IDAsIGI6IDAsIGFscGhhOiAwIH0sXG4gICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgd2lkdGg6IHdpZHRoLFxuICAgICAgICAgIGhlaWdodDogaGVpZ2h0LFxuICAgICAgICAgIGNoYW5uZWxzOiBjaGFubmVscyxcbiAgICAgICAgICBiYWNrZ3JvdW5kOiBiYWNrZ3JvdW5kXG4gICAgICAgIH0sXG4gICAgICAgIGltYWdlTWFwID0gc2hhcnAoe1xuICAgICAgICAgIGNyZWF0ZTogb3B0aW9ucyAvLy9cbiAgICAgICAgfSk7XG5cbiAgaW1hZ2VNYXBcbiAgICAucG5nKClcbiAgICAudG9CdWZmZXIoKVxuICAgIC50aGVuKGZ1bmN0aW9uKGJ1ZmZlcikge1xuICAgICAgY2FsbGJhY2soYnVmZmVyKVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBvdmVybGF5Q2FsbGJhY2sobmV4dCwgZG9uZSwgY29udGV4dCwgaW5kZXgpIHtcbiAgY29uc3QgeyBuYW1lcywgYnVmZmVyLCBkaW1lbnNpb24sIG92ZXJsYXlJbWFnZVNpemUsIGltYWdlRGlyZWN0b3J5UGF0aCB9ID0gY29udGV4dCxcbiAgICAgICAgbmFtZXNMZW5ndGggPSBuYW1lcy5sZW5ndGgsXG4gICAgICAgIGxhc3RJbmRleCA9IG5hbWVzTGVuZ3RoIC0gMTtcblxuICBpZiAoaW5kZXggPiBsYXN0SW5kZXgpIHtcbiAgICBkb25lKCk7XG4gICAgXG4gICAgcmV0dXJuO1xuICB9XG4gIFxuICBjb25zdCBuYW1lID0gbmFtZXNbaW5kZXhdLFxuICAgICAgICBwYXRoID0gYCR7aW1hZ2VEaXJlY3RvcnlQYXRofS8ke25hbWV9YDtcblxuICByZXNpemVJbWFnZShwYXRoLCBvdmVybGF5SW1hZ2VTaXplLCBmdW5jdGlvbihyZXNpemVkSW1hZ2VCdWZmZXIpIHtcbiAgICBjb25zdCB0b3AgPSAoKGRpbWVuc2lvbiAtIDEpIC0gTWF0aC5mbG9vcihpbmRleCAvIGRpbWVuc2lvbikgKSAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgICAgbGVmdCA9IChpbmRleCAlIGRpbWVuc2lvbikgKiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICB0b3A6IHRvcCxcbiAgICAgICAgICAgIGxlZnQ6IGxlZnRcbiAgICAgICAgICB9O1xuXG4gICAgc2hhcnAoYnVmZmVyKVxuICAgICAgLm92ZXJsYXlXaXRoKHJlc2l6ZWRJbWFnZUJ1ZmZlciwgb3B0aW9ucylcbiAgICAgIC50b0J1ZmZlcigpXG4gICAgICAudGhlbihmdW5jdGlvbihidWZmZXIpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihjb250ZXh0LCB7XG4gICAgICAgICAgYnVmZmVyOiBidWZmZXJcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbmV4dCgpO1xuICAgICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZXNpemVJbWFnZShwYXRoLCBvdmVybGF5SW1hZ2VTaXplLCBjYWxsYmFjaykge1xuICBjb25zdCB3aWR0aCA9IG92ZXJsYXlJbWFnZVNpemUsIC8vL1xuICAgICAgICBoZWlnaHQgPSBvdmVybGF5SW1hZ2VTaXplOyAgLy8vXG4gIFxuICBzaGFycChwYXRoKVxuICAgIC5yZXNpemUod2lkdGgsIGhlaWdodClcbiAgICAudG9CdWZmZXIoKVxuICAgIC50aGVuKGZ1bmN0aW9uKGJ1ZmZlcikge1xuICAgICAgY29uc3QgcmVzaXplZEltYWdlQnVmZmVyID0gYnVmZmVyOyAvLy9cbiAgICAgIFxuICAgICAgY2FsbGJhY2socmVzaXplZEltYWdlQnVmZmVyKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gZGltZW5zaW9uRnJvbU5hbWVzKG5hbWVzKSB7XG4gIGNvbnN0IG5hbWVzTGVuZ3RoID0gbmFtZXMubGVuZ3RoLFxuICAgICAgICBkaW1lbnNpb24gPSBNYXRoLmNlaWwoTWF0aC5zcXJ0KG5hbWVzTGVuZ3RoKSk7IC8vL1xuXG4gIHJldHVybiBkaW1lbnNpb247XG59XG4iXX0=