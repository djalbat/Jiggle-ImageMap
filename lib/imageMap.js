'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var fileSystemUtilities = necessary.fileSystemUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    miscellaneousUtilities = necessary.miscellaneousUtilities,
    rc = miscellaneousUtilities.rc,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory;


function png(imageDirectoryPath, overlayImageSize, response) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names);

  createImageMap(dimension, overlayImageSize, function (buffer) {
    var context = {
      buffer: buffer,
      names: names,
      dimension: dimension,
      overlayImageSize: overlayImageSize,
      imageDirectoryPath: imageDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var buffer = context.buffer;


      sharp(buffer).pipe(response);
    }, context);
  });
}

function json(imageDirectoryPath) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names),
      json = names.reduce(function (json, name, index) {
    var left = index % dimension / dimension,
        bottom = Math.floor(index / dimension) / dimension,
        width = 1 / dimension,
        height = 1 / dimension;

    json[name] = {
      left: left,
      bottom: bottom,
      width: width,
      height: height
    };

    return json;
  }, {});

  return json;
}

module.exports = {
  respond: respond,
  json: json
};

function createImageMap(dimension, overlayImageSize, callback) {
  var width = dimension * overlayImageSize,
      height = dimension * overlayImageSize,
      channels = 4,
      background = { r: 0, g: 0, b: 0, alpha: 0 },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      imageMap = sharp({
    create: options ///
  });

  imageMap.png().toBuffer().then(function (buffer) {
    callback(buffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      buffer = context.buffer,
      dimension = context.dimension,
      overlayImageSize = context.overlayImageSize,
      imageDirectoryPath = context.imageDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = imageDirectoryPath + '/' + name;

  resizeImage(path, overlayImageSize, function (resizedImageBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayImageSize,
        left = index % dimension * overlayImageSize,
        options = {
      top: top,
      left: left
    };

    sharp(buffer).overlayWith(resizedImageBuffer, options).toBuffer().then(function (buffer) {
      Object.assign(context, {
        buffer: buffer
      });

      next();
    });
  });
}

function resizeImage(path, overlayImageSize, callback) {
  var width = overlayImageSize,
      ///
  height = overlayImageSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (buffer) {
    var resizedImageBuffer = buffer; ///

    callback(resizedImageBuffer);
  });
}

function dimensionFromNames(names) {
  var namesLength = names.length,
      dimension = Math.ceil(Math.sqrt(namesLength)); ///

  return dimension;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9pbWFnZU1hcC5qcyJdLCJuYW1lcyI6WyJzaGFycCIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJmaWxlU3lzdGVtVXRpbGl0aWVzIiwiYXN5bmNocm9ub3VzVXRpbGl0aWVzIiwibWlzY2VsbGFuZW91c1V0aWxpdGllcyIsInJjIiwid2hpbHN0IiwicmVhZERpcmVjdG9yeSIsInJlc3BvbmQiLCJpbWFnZURpcmVjdG9yeVBhdGgiLCJvdmVybGF5SW1hZ2VTaXplIiwicmVzcG9uc2UiLCJuYW1lcyIsImRpbWVuc2lvbiIsImRpbWVuc2lvbkZyb21OYW1lcyIsImNyZWF0ZUltYWdlTWFwIiwiYnVmZmVyIiwiY29udGV4dCIsIm92ZXJsYXlDYWxsYmFjayIsIndyaXRlSGVhZCIsInBpcGUiLCJqc29uIiwicmVkdWNlIiwibmFtZSIsImluZGV4IiwibGVmdCIsImJvdHRvbSIsIk1hdGgiLCJmbG9vciIsIndpZHRoIiwiaGVpZ2h0IiwibW9kdWxlIiwiZXhwb3J0cyIsImNhbGxiYWNrIiwiY2hhbm5lbHMiLCJiYWNrZ3JvdW5kIiwiciIsImciLCJiIiwiYWxwaGEiLCJvcHRpb25zIiwiaW1hZ2VNYXAiLCJjcmVhdGUiLCJwbmciLCJ0b0J1ZmZlciIsInRoZW4iLCJuZXh0IiwiZG9uZSIsIm5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwibGFzdEluZGV4IiwicGF0aCIsInJlc2l6ZUltYWdlIiwicmVzaXplZEltYWdlQnVmZmVyIiwidG9wIiwib3ZlcmxheVdpdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJyZXNpemUiLCJjZWlsIiwic3FydCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsUUFBUUMsUUFBUSxPQUFSLENBQWQ7QUFBQSxJQUNNQyxZQUFZRCxRQUFRLFdBQVIsQ0FEbEI7O0lBR1FFLG1CLEdBQXVFRCxTLENBQXZFQyxtQjtJQUFxQkMscUIsR0FBa0RGLFMsQ0FBbERFLHFCO0lBQXVCQyxzQixHQUEyQkgsUyxDQUEzQkcsc0I7SUFDNUNDLEUs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QUMxQm9CLFdBQVNwQixnQkFEZixDQURxRCxDQUVuQjs7QUFFbENYLFFBQU1vRCxJQUFOLEVBQ0dPLE1BREgsQ0FDVTdCLEtBRFYsRUFDaUJDLE1BRGpCLEVBRUdjLFFBRkgsR0FHR0MsSUFISCxDQUdRLFVBQVM3QixNQUFULEVBQWlCO0FBQ3JCLFFBQU1xQyxxQkFBcUJyQyxNQUEzQixDQURxQixDQUNjOztBQUVuQ2lCLGFBQVNvQixrQkFBVDtBQUNELEdBUEg7QUFRRDs7QUFFRCxTQUFTdkMsa0JBQVQsQ0FBNEJGLEtBQTVCLEVBQW1DO0FBQ2pDLE1BQU1vQyxjQUFjcEMsTUFBTXFDLE1BQTFCO0FBQUEsTUFDTXBDLFlBQVljLEtBQUtnQyxJQUFMLENBQVVoQyxLQUFLaUMsSUFBTCxDQUFVWixXQUFWLENBQVYsQ0FEbEIsQ0FEaUMsQ0FFb0I7O0FBRXJELFNBQU9uQyxTQUFQO0FBQ0QiLCJmaWxlIjoiaW1hZ2VNYXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHNoYXJwID0gcmVxdWlyZSgnc2hhcnAnKSxcbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCB7IGZpbGVTeXN0ZW1VdGlsaXRpZXMsIGFzeW5jaHJvbm91c1V0aWxpdGllcywgbWlzY2VsbGFuZW91c1V0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyByYyB9ID0gbWlzY2VsbGFuZW91c1V0aWxpdGllcyxcbiAgICAgIHsgd2hpbHN0IH0gPSBhc3luY2hyb25vdXNVdGlsaXRpZXMsXG4gICAgICB7IHJlYWREaXJlY3RvcnkgfSA9IGZpbGVTeXN0ZW1VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIHJlc3BvbmQoaW1hZ2VEaXJlY3RvcnlQYXRoLCBvdmVybGF5SW1hZ2VTaXplLCByZXNwb25zZSkge1xuICBjb25zdCBuYW1lcyA9IHJlYWREaXJlY3RvcnkoaW1hZ2VEaXJlY3RvcnlQYXRoKSxcbiAgICAgICAgZGltZW5zaW9uID0gZGltZW5zaW9uRnJvbU5hbWVzKG5hbWVzKTtcblxuICBjcmVhdGVJbWFnZU1hcChkaW1lbnNpb24sIG92ZXJsYXlJbWFnZVNpemUsIGZ1bmN0aW9uKGJ1ZmZlcikge1xuICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICBidWZmZXI6IGJ1ZmZlcixcbiAgICAgIG5hbWVzOiBuYW1lcyxcbiAgICAgIGRpbWVuc2lvbjogZGltZW5zaW9uLFxuICAgICAgb3ZlcmxheUltYWdlU2l6ZTogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgIGltYWdlRGlyZWN0b3J5UGF0aDogaW1hZ2VEaXJlY3RvcnlQYXRoXG4gICAgfTtcbiAgICBcbiAgICB3aGlsc3Qob3ZlcmxheUNhbGxiYWNrLCBmdW5jdGlvbigpIHtcbiAgICAgIHJlc3BvbnNlLndyaXRlSGVhZCgyMDAsIHsnQ29udGVudC1UeXBlJzogJ2ltYWdlL3BuZzsgY2hhcnNldD11dGYtOCd9KTtcblxuICAgICAgY29uc3QgeyBidWZmZXIgfSA9IGNvbnRleHQ7XG5cbiAgICAgIHNoYXJwKGJ1ZmZlcikucGlwZShyZXNwb25zZSk7XG4gICAgfSwgY29udGV4dCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBqc29uKGltYWdlRGlyZWN0b3J5UGF0aCkge1xuICBjb25zdCBuYW1lcyA9IHJlYWREaXJlY3RvcnkoaW1hZ2VEaXJlY3RvcnlQYXRoKSxcbiAgICAgICAgZGltZW5zaW9uID0gZGltZW5zaW9uRnJvbU5hbWVzKG5hbWVzKSxcbiAgICAgICAganNvbiA9IG5hbWVzLnJlZHVjZShmdW5jdGlvbihqc29uLCBuYW1lLCBpbmRleCkge1xuICAgICAgICAgIGNvbnN0IGxlZnQgPSAoaW5kZXggJSBkaW1lbnNpb24pIC8gZGltZW5zaW9uLFxuICAgICAgICAgICAgICAgIGJvdHRvbSA9IE1hdGguZmxvb3IoaW5kZXggLyBkaW1lbnNpb24pIC8gZGltZW5zaW9uLFxuICAgICAgICAgICAgICAgIHdpZHRoID0gMSAvIGRpbWVuc2lvbixcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSAxIC8gZGltZW5zaW9uO1xuXG4gICAgICAgICAganNvbltuYW1lXSA9IHtcbiAgICAgICAgICAgIGxlZnQ6IGxlZnQsXG4gICAgICAgICAgICBib3R0b206IGJvdHRvbSxcbiAgICAgICAgICAgIHdpZHRoOiB3aWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIHJldHVybiBqc29uO1xuICAgICAgICB9LCB7fSk7XG4gICAgICAgIFxuICByZXR1cm4ganNvbjtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHJlc3BvbmQ6IHJlc3BvbmQsXG4gIGpzb246IGpzb25cbn07XG5cbmZ1bmN0aW9uIGNyZWF0ZUltYWdlTWFwKGRpbWVuc2lvbiwgb3ZlcmxheUltYWdlU2l6ZSwgIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHdpZHRoID0gZGltZW5zaW9uICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgaGVpZ2h0ID0gZGltZW5zaW9uICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgY2hhbm5lbHMgPSA0LFxuICAgICAgICBiYWNrZ3JvdW5kID0geyByOiAwLCBnOiAwLCBiOiAwLCBhbHBoYTogMCB9LFxuICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgIHdpZHRoOiB3aWR0aCxcbiAgICAgICAgICBoZWlnaHQ6IGhlaWdodCxcbiAgICAgICAgICBjaGFubmVsczogY2hhbm5lbHMsXG4gICAgICAgICAgYmFja2dyb3VuZDogYmFja2dyb3VuZFxuICAgICAgICB9LFxuICAgICAgICBpbWFnZU1hcCA9IHNoYXJwKHtcbiAgICAgICAgICBjcmVhdGU6IG9wdGlvbnMgLy8vXG4gICAgICAgIH0pO1xuXG4gIGltYWdlTWFwXG4gICAgLnBuZygpXG4gICAgLnRvQnVmZmVyKClcbiAgICAudGhlbihmdW5jdGlvbihidWZmZXIpIHtcbiAgICAgIGNhbGxiYWNrKGJ1ZmZlcilcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gb3ZlcmxheUNhbGxiYWNrKG5leHQsIGRvbmUsIGNvbnRleHQsIGluZGV4KSB7XG4gIGNvbnN0IHsgbmFtZXMsIGJ1ZmZlciwgZGltZW5zaW9uLCBvdmVybGF5SW1hZ2VTaXplLCBpbWFnZURpcmVjdG9yeVBhdGggfSA9IGNvbnRleHQsXG4gICAgICAgIG5hbWVzTGVuZ3RoID0gbmFtZXMubGVuZ3RoLFxuICAgICAgICBsYXN0SW5kZXggPSBuYW1lc0xlbmd0aCAtIDE7XG5cbiAgaWYgKGluZGV4ID4gbGFzdEluZGV4KSB7XG4gICAgZG9uZSgpO1xuICAgIFxuICAgIHJldHVybjtcbiAgfVxuICBcbiAgY29uc3QgbmFtZSA9IG5hbWVzW2luZGV4XSxcbiAgICAgICAgcGF0aCA9IGAke2ltYWdlRGlyZWN0b3J5UGF0aH0vJHtuYW1lfWA7XG5cbiAgcmVzaXplSW1hZ2UocGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgZnVuY3Rpb24ocmVzaXplZEltYWdlQnVmZmVyKSB7XG4gICAgY29uc3QgdG9wID0gKChkaW1lbnNpb24gLSAxKSAtIE1hdGguZmxvb3IoaW5kZXggLyBkaW1lbnNpb24pICkgKiBvdmVybGF5SW1hZ2VTaXplLFxuICAgICAgICAgIGxlZnQgPSAoaW5kZXggJSBkaW1lbnNpb24pICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgICAgdG9wOiB0b3AsXG4gICAgICAgICAgICBsZWZ0OiBsZWZ0XG4gICAgICAgICAgfTtcblxuICAgIHNoYXJwKGJ1ZmZlcilcbiAgICAgIC5vdmVybGF5V2l0aChyZXNpemVkSW1hZ2VCdWZmZXIsIG9wdGlvbnMpXG4gICAgICAudG9CdWZmZXIoKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oYnVmZmVyKSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oY29udGV4dCwge1xuICAgICAgICAgIGJ1ZmZlcjogYnVmZmVyXG4gICAgICAgIH0pO1xuXG4gICAgICAgIG5leHQoKTtcbiAgICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gcmVzaXplSW1hZ2UocGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgY2FsbGJhY2spIHtcbiAgY29uc3Qgd2lkdGggPSBvdmVybGF5SW1hZ2VTaXplLCAvLy9cbiAgICAgICAgaGVpZ2h0ID0gb3ZlcmxheUltYWdlU2l6ZTsgIC8vL1xuICBcbiAgc2hhcnAocGF0aClcbiAgICAucmVzaXplKHdpZHRoLCBoZWlnaHQpXG4gICAgLnRvQnVmZmVyKClcbiAgICAudGhlbihmdW5jdGlvbihidWZmZXIpIHtcbiAgICAgIGNvbnN0IHJlc2l6ZWRJbWFnZUJ1ZmZlciA9IGJ1ZmZlcjsgLy8vXG4gICAgICBcbiAgICAgIGNhbGxiYWNrKHJlc2l6ZWRJbWFnZUJ1ZmZlcik7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGRpbWVuc2lvbkZyb21OYW1lcyhuYW1lcykge1xuICBjb25zdCBuYW1lc0xlbmd0aCA9IG5hbWVzLmxlbmd0aCxcbiAgICAgICAgZGltZW5zaW9uID0gTWF0aC5jZWlsKE1hdGguc3FydChuYW1lc0xlbmd0aCkpOyAvLy9cblxuICByZXR1cm4gZGltZW5zaW9uO1xufVxuIl19